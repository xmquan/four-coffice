<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>双栏文本编辑器</title>

	<!-- CSS样式部分 -->
	<style>
		/* 全局变量 */
		:root {
			/* 颜色 */
			--bg-color: #f5f5f5;
			--toolbar-color: #e0e0e0;
			--border-color: #bdbdbd;
			--text-color: #333;
			--highlight-color: #90caf9;

			/* 间距 */
			--base-padding: 8px;
			--small-padding: 4px;

			/* 阴影 */
			--base-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			--hover-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
			--active-shadow: 0 4px 8px rgba(144, 202, 249, 0.3);

			/* 圆角 */
			border-radius: var(--small-padding);
			--base-transition: all 0.2s ease;
		}

		/* 基础样式 */
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 0;
			padding: 0;
			background-color: var(--bg-color);
			color: var(--text-color);
			height: 100vh;
			display: flex;
			flex-direction: column;
		}

		/* 工具栏样式 - 顶部操作按钮区域 */
		.toolbar {
			background-color: var(--toolbar-color);
			padding: var(--base-padding);
			border-bottom: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
			gap: var(--base-padding);
		}

		/* 工具栏行 - 用于分组按钮 */
		.toolbar-row {
			display: flex;
			justify-content: space-between;
		}

		/* 工具组 - 用于分组按钮 */
		.tool-group {
			display: flex;
			gap: var(--base-padding);
		}

		/* 工具栏按钮样式 */
		button {
			padding: 6px 12px;
			background-color: white;
			border: 1px solid var(--border-color);
			border-radius: var(--small-padding);
			cursor: pointer;
			transition: all 0.2s ease;
			min-width: 24px;
			text-align: center;
		}

		/* 按钮悬停和点击效果 */
		button:hover {
			background-color: #eee;
			box-shadow: var(--base-shadow);
		}

		/* 按钮点击效果 */
		button:active {
			transform: translateY(0);
			box-shadow: none;
		}

		/* 格式化按钮特殊样式 */
		#bold-btn,
		#italic-btn,
		#underline-btn,
		#strike-btn {
			font-weight: bold;
			font-family: 'Times New Roman', serif;
		}

		/* 搜索按钮特殊样式 */
		#search-btn {
			background-color: white;
			border: 1px solid var(--border-color);
			border-radius: var(--small-padding);
			padding: 6px 28px 6px 36px;
			/* 左侧留出图标空间，右侧和下拉框一致 */
			font-size: 14px;
			height: 36px;
			/* 与下拉框高度一致 */
			min-width: 90px;
			border-radius: var(--small-padding);
			cursor: pointer;
			position: relative;
			margin-right: 8px;
			appearance: none;
			-webkit-appearance: none;
			-moz-appearance: none;
			display: inline-flex;
			align-items: center;
			transition: var(--base-transition);
		}

		/* 搜索按钮图标*/
		#search-btn::before {
			content: "";
			display: inline-block;
			position: absolute;
			left: 12px;
			top: 50%;
			transform: translateY(-50%);
			width: 16px;
			height: 16px;
			background: url("data:image/svg+xml;utf8,<svg width='16' height='16' xmlns='http://www.w3.org/2000/svg'><circle cx='7' cy='7' r='5' stroke='%23bbb' stroke-width='2' fill='none'/><line x1='11' y1='11' x2='15' y2='15' stroke='%23bbb' stroke-width='2' stroke-linecap='round'/></svg>") no-repeat center/16px 16px;
			/* 浅灰色放大镜SVG */
		}

		/* 搜索按钮悬停效果*/
		#search-btn:hover {
			background-color: #e3f2fd;
			border-color: #64b5f6;
		}

		/* 搜索按钮点击效果*/
		#bold-btn {
			font-weight: 900;
		}

		/* 粗体按钮样式*/
		#italic-btn {
			font-style: italic;
		}

		/* 斜体按钮样式*/
		#underline-btn {
			text-decoration: underline;
		}

		/* 下划线按钮样式*/
		#strike-btn {
			text-decoration: line-through;
		}

		/* 删除线按钮样式*/
		#link-btn,
		#image-btn,
		#code-btn {
			font-size: 14px;
			padding: 6px var(--base-padding);
		}

		/* 链接、图片、代码按钮样式*/
		.editor-container {
			display: flex;
			flex: 1;
			overflow: hidden;
		}

		/* 主内容区样式 */
		.title-panel,
		.content-panel {
			flex: 1;
			display: flex;
			flex-direction: column;
			padding: var(--base-padding);
			overflow: hidden;
		}

		/* 标题栏和内容栏样式 */
		.title-tools {
			display: flex;
			gap: 8px;
			margin-bottom: 12px;
			justify-content: flex-start;
			flex-wrap: wrap;
		}

		/* 标题工具栏样式 */
		.title-panel .tool-group button {
			min-width: 48px;
			font-size: 14px;
			padding: 6px 12px;
		}

		/* 标题工具栏按钮样式 */
		.title-panel {
			border-right: 1px solid var(--border-color);
			max-width: 340px;
			/* 可适当放大 */
			min-width: 220px;
			display: flex;
			flex-direction: column;
			padding: var(--base-padding);
			overflow: hidden;
			background: #fafbfc;
		}

		/* 标题栏样式 */
		.panel-header {
			font-weight: bold;
			margin-bottom: var(--base-padding);
		}

		/* 内容面板样式 */
		.content-panel .panel-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px;
			font-weight: bold;
			font-size: 16px;
		}

		/* 内容面板头部样式 */
		.content-tools {
			display: flex;
			gap: 8px;
			align-items: center;
			/* 保证和下拉框、按钮风格一致 */
		}

		/* 编辑器样式 */
		.editor {
			flex: 1;
			border: 1px solid var(--border-color);
			background-color: white;
			padding: var(--base-padding);
			overflow-y: scroll;
			outline: none;
			scrollbar-width: thin;
			scrollbar-color: #c1c1c1 #f1f1f1;
		}

		/* 滚动条样式 */
		.editor::-webkit-scrollbar {
			width: 36px;
			height: 36px;
			display: block;
		}

		/* 自定义滚动条样式 */
		.editor::-webkit-scrollbar-thumb {
			background-color: #c1c1c1;
			border-radius: 18px;
			border: 6px solid #f1f1f1;
		}

		/* 自定义滚动条样式 */
		.editor::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 18px;
			box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
		}

		/* 自定义滚动条样式 */
		.editor::-webkit-scrollbar-thumb:hover {
			background-color: #a8a8a8;
		}

		/* 确保内容足够触发滚动条 */
		#title-list {
			min-height: 200px;
			/* max-height: 60vh; */
			/* 限制最大高度，超出时出现滚动条 */
			overflow-y: auto;
			/* 超出时显示垂直滚动条 */
			/* 可选：美化滚动条 */
			scrollbar-width: thin;
			scrollbar-color: #c1c1c1 #f1f1f1;
		}

		/* 标题列表样式 */
		#title-list::-webkit-scrollbar {
			width: 36px;
			height: 36px;
			display: block;
		}

		/* 标题列表滚动条样式 */
		#title-list::-webkit-scrollbar-thumb {
			background: #c1c1c1;
			border-radius: 18px;
			border: 6px solid #f1f1f1;
		}

		/* 标题列表滚动条样式 */
		#title-list::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 18px;
			box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
		}

		/* 标题列表滚动条样式 */
		#content-editor {
			min-height: 300px;
			/* 设置最小高度确保有足够空间显示滚动条 */
			resize: none;
			/* 禁止通过鼠标调整大小 */
			font-family: "微软雅黑", "Microsoft YaHei", Arial, sans-serif;
			font-size: 20px;
			letter-spacing: 2px;
			line-height: 1.5;
		}

		/* 状态栏样式 */
		.status-bar {
			height: auto;
			min-height: 24px;
			font-size: 12px;
			padding: var(--small-padding) var(--base-padding);
			background-color: var(--toolbar-color);
			border-top: 1px solid var(--border-color);
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			overflow-x: auto;
			white-space: nowrap;
		}

		/* 状态栏样式 */
		.status-item {
			margin-right: var(--base-padding);
			display: inline-flex;
			align-items: center;
		}

		/* 状态栏项样式 */
		.status-saved {
			margin-left: var(--base-padding);
			color: #4CAF50;
			transition: all 0.3s ease;
			opacity: 1;
		}

		/* 状态栏已保存样式 */
		.status-messages {
			flex: 1;
			display: flex;
			flex-wrap: wrap;
			margin-right: 10px;
			overflow: hidden;
		}

		/* 状态栏消息容器 */
		.status-message {
			background-color: rgba(144, 202, 249, 0.2);
			border-radius: var(--small-padding);
			padding: 2px 6px;
			margin-right: 5px;
			margin-bottom: 3px;
			white-space: nowrap;
		}

		/* 状态栏消息样式 */
		.status-stats {
			flex-shrink: 0;
			text-align: right;
		}

		/* 响应式设计 */
		@media (max-width: 768px) {
			.status-bar {
				font-size: 11px;
			}

			.status-item {
				margin-right: var(--small-padding);
			}
		}

		/* 标题项样式 */
		.title-item {
			padding: 12px;
			margin-bottom: var(--base-padding);
			cursor: pointer;
			border-radius: var(--base-padding);
			background-color: white;
			box-shadow: 0 2px var(--small-padding) rgba(0, 0, 0, 0.1);
			transition: all 0.2s ease;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		/* 标题项样式 */
		.title-item:hover {
			background-color: #f5f5f5;
			box-shadow: 0 var(--small-padding) var(--base-padding) rgba(0, 0, 0, 0.15);
		}

		/* 标题项悬停效果 */
		.title-item.active {
			background-color: var(--highlight-color);
			box-shadow: 0 var(--small-padding) var(--base-padding) rgba(144, 202, 249, 0.3);
			border-left: var(--small-padding) solid #1976d2;
		}

		/* 标题项激活状态样式 */
		.title-item {

			font-weight: 500;
		}

		/* 移除编辑按钮相关样式 */
		input[type="file"] {
			display: none;
		}

		/* 搜索和替换对话框样式 */
		.search-dialog {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 400px;
			max-height: 80vh;
			background-color: var(--bg-color);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			border-radius: var(--base-padding);
			box-shadow: 0 var(--small-padding) 12px rgba(0, 0, 0, 0.15);
			padding: 20px;
			z-index: 1000;
			display: none;
			overflow-y: auto;
		}

		/* 搜索对话框样式 */
		.search-dialog .dialog-header {
			padding: var(--base-padding) 16px;
			margin: -20px -20px 10px -20px;
			background: var(--toolbar-color);
			border-radius: var(--base-padding) var(--base-padding) 0 0;
			cursor: move;
			-webkit-user-select: none;
			/* 兼容 Safari */
			user-select: none;
		}

		/* 搜索对话框头部样式 */
		.search-dialog.active {
			display: block;
		}

		/* 搜索对话框激活状态样式 */
		.search-dialog .close-button {
			position: absolute;
			right: 12px;
			top: 16px;
			font-size: 20px;
			color: #aaa;
			cursor: pointer;
			transform: scale(0.8) translateX(2px);
			transition: 0.2s ease;
		}

		/* 关闭按钮样式 */
		.search-dialog .search-header {
			margin-top: 0;
			margin-bottom: 12px;
			font-size: 16px;
			font-weight: bold;
			color: var(--text-color);
			border-bottom: 1px solid var(--border-color);
			padding-bottom: var(--base-padding);
		}

		/* 搜索对话框标题样式 */
		.search-dialog .search-content {
			padding: var(--base-padding) 0;
		}

		/* 搜索对话框内容样式 */
		.search-dialog .form-group {
			margin-bottom: 12px;
		}

		/* 搜索对话框表单组样式 */
		.search-dialog label {
			display: block;
			margin-bottom: var(--small-padding);
			font-size: 14px;
		}

		/* 搜索对话框标签样式 */
		.search-dialog input[type="text"] {
			width: 96%;
			padding: 6px var(--base-padding);
			border: 1px solid var(--border-color);
			border-radius: var(--small-padding);
			font-size: 14px;
		}

		/* 搜索对话框输入框样式 */
		.search-dialog .options {
			display: flex;
			margin-bottom: 12px;
		}

		/* 搜索对话框选项容器样式 */
		.search-dialog .option {
			margin-right: 12px;
			font-size: 14px;
		}

		/* 搜索对话框选项样式 */
		.search-dialog .buttons {
			display: flex;
			flex-wrap: wrap;
			gap: 5px;
			justify-content: space-between;
		}

		/* 搜索对话框按钮容器样式 */
		.search-dialog .buttons button,
		.search-dialog .scope-btn {
			padding: var(--small-padding) var(--base-padding);
			font-size: 12px;
			border: 1px solid var(--border-color);
			border-radius: var(--base-radius);
			background-color: white;
			cursor: pointer;
			transition: var(--base-transition);
		}

		/* 搜索对话框按钮样式 */
		.search-dialog .scope-btn.active {
			background-color: var(--highlight-color);
			border-color: var(--highlight-color);
			color: white;
		}

		/* 搜索对话框作用域按钮激活状态样式 */
		.search-dialog .result-info {
			font-size: 12px;
			margin-top: var(--base-padding);
			color: #666;
		}

		/* 搜索对话框结果信息样式 */
		.dropdown {
			padding: 6px 28px 6px 12px;
			border: 1px solid var(--border-color);
			border-radius: var(--small-padding);
			background: white url("data:image/svg+xml;utf8,<svg width='20' height='20' xmlns='http://www.w3.org/2000/svg'><polyline points='5,8 10,13 15,8' fill='none' stroke='%23bbb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>") no-repeat right 8px center/20px 20px;
			font-size: 14px;
			margin-right: 8px;
			min-width: 90px;
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			cursor: pointer;
		}

		/* 下拉框样式 */
		input[type="file"] {
			display: none;
		}
	</style>
</head>

<body>
	<!-- 顶部工具栏 -->
	<div class="toolbar">
		<div class="toolbar-row">
			<!-- 工具栏元素-->
			<div class="tool-group">
				<button id="new-btn">新建</button>
				<button id="open-btn">打开</button>

				<button id="save-btn">保存</button>
				<button id="close-btn">关闭</button>
			</div>
			<input type="file" id="file-input" accept=".txt" aria-label="打开文本文件">
		</div>
	</div>

	<!-- 主内容区 -->
	<div class="editor-container">
		<!-- 标题栏 -->
		<div class="title-panel">
			<!-- 标题栏头部 -->
			<div class="tool-group title-tools">
				<button id="add-title-btn">增加</button>
				<button id="remove-title-btn">移除</button>
				<button id="edit-title-btn">编辑</button>
				<button id="move-up-btn">上移</button>
				<button id="move-down-btn">下移</button>
			</div>
			<div id="title-list"></div>
		</div>
		<!-- 内容栏 -->
		<div class="content-panel">
			<!-- 内容栏头部 -->
			<div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
				<div class="content-tools">
					<select id="font-size-select" class="dropdown" aria-label="字号选择">
						<option value="20px">字号：20px</option>
						<option value="18px">字号：18px</option>
						<option value="20px">字号：20px</option>
						<option value="24px">字号：24px</option>
					</select>
					<select id="line-height-select" class="dropdown" aria-label="行距选择">
						<option value="1.5">行距：1.5</option>
						<option value="1.2">行距：1.2</option>
						<option value="1.5">行距：1.5</option>
						<option value="2.0">行距：2.0</option>
					</select>
					<select id="letter-spacing-select" class="dropdown" aria-label="字距选择">
						<option value="2px">字距：2px</option>
						<option value="1px">字距：1px</option>
						<option value="2px">字距：2px</option>
						<option value="4px">字距：4px</option>
					</select>
					<button id="search-btn">搜索</button>
				</div>
			</div>
			<textarea id="content-editor" class="editor" placeholder="请输入内容"></textarea>
			<!-- 状态栏 -->
			<div class="status-bar">
				<div class="status-messages" id="status-messages"></div>
				<div class="status-stats" id="status-info">行: 0 | 字数: 0 | 总字数: 0</div>
			</div>
		</div>
	</div>

	<!-- 搜索和替换对话框 -->
	<div id="search-dialog" class="search-dialog">
		<div class="dialog-header">搜索和替换</div>
		<div class="search-header">搜索选项</div>
		<div class="search-content">
			<div class="form-group">
				<label for="search-input">查找内容:</label>
				<input type="text" id="search-input" placeholder="输入要查找的文本">
			</div>
			<div class="form-group">
				<label for="replace-input">替换为:</label>
				<input type="text" id="replace-input" placeholder="输入要替换的文本">
			</div>
			<div class="options">
				<div class="option">
					<input type="checkbox" id="case-sensitive">
					<label for="case-sensitive">区分大小写</label>
				</div>
				<div class="option">
					<input type="checkbox" id="whole-word">
					<label for="whole-word">全字匹配</label>
				</div>
				<div class="option">
					<button id="search-current" class="scope-btn " data-scope="current">当前视图</button>
				</div>
				<div class="option">
					<button id="search-all" class="scope-btn active" data-scope="all">整个文档</button>
				</div>
			</div>
			<div class="buttons">
				<button id="find-btn">查找</button>
				<button id="find-prev-btn">上一个</button>
				<button id="find-next-btn">下一个</button>
				<button id="replace-btn">替换</button>
				<button id="replace-all-btn">全部替换</button>
				<button id="close-search-btn">关闭</button>
			</div>
			<div class="result-info" id="search-result-info"></div>
		</div>
	</div>

	<!-- JavaScript功能实现 -->
	<script>
		// 全局变量：存储所有文档对象
		window.documents = [];
		// 全局变量：当前激活的标题索引
		window.activeTitleIndex = -1;
		// 全局变量：标记文档是否被修改
		window.isModified = false;
		// 全局变量：编辑器历史记录系统
		window.editorHistory = {
			records: [""],
			index: 0,
			MAX: 100,

			// 添加历史记录方法
			add: function (content) {
				if (this.index < this.records.length - 1) {
					this.records = this.records.slice(0, this.index + 1);
				}
				this.records.push(content);
				this.index = this.records.length - 1;

				// 限制历史记录数量
				if (this.records.length > this.MAX) {
					this.records.shift();
					this.index--;
				}
			}
		};

		// 全局updateStatus函数
		function updateStatus() {
			// 确保依赖变量已初始化
			if (typeof debouncedUpdateStatus !== 'undefined') {
				debouncedUpdateStatus();
			}
		}

		// 当DOM完全加载后执行初始化
		document.addEventListener('DOMContentLoaded', function () {
			// 获取关键DOM元素引用			
			window.contentEditor = document.getElementById('content-editor');
			window.statusInfo = document.getElementById('status-info');
			const fileInput = document.getElementById('file-input');
			const titleList = document.getElementById('title-list');

			// 初始化编辑器，设置初始状态
			initEditor();

			// 顶部工具栏按钮事件绑定
			// document.getElementById('new-btn').addEventListener('click', newDocument);
			document.getElementById('open-btn').addEventListener('click', () => fileInput.click());
			document.getElementById('save-btn').addEventListener('click', saveDocument);
			document.getElementById('close-btn').addEventListener('click', closeDocument);

			// 标题栏按钮事件绑定
			// document.getElementById('add-title-btn').addEventListener('click', addTitle);
			document.getElementById('remove-title-btn').addEventListener('click', removeTitle);
			document.getElementById('move-up-btn').addEventListener('click', moveTitleUp);
			document.getElementById('move-down-btn').addEventListener('click', moveTitleDown);

			// 添加字体样式按钮事件
			document.getElementById('search-btn').addEventListener('click', toggleSearchDialog);


			// ================== 内容栏相关功能 ==================

			// 监听字号、行距、字距下拉框变化，实时应用到编辑区
			document.getElementById('font-size-select').addEventListener('change', function () {
				contentEditor.style.fontSize = this.value;
			});
			document.getElementById('line-height-select').addEventListener('change', function () {
				contentEditor.style.lineHeight = this.value;
			});
			document.getElementById('letter-spacing-select').addEventListener('change', function () {
				contentEditor.style.letterSpacing = this.value;
			});

			// 监听内容编辑事件，自动在新段落加TAB
			contentEditor.addEventListener('input', function (e) {
				// 判断是否是新起一行
				const value = contentEditor.value;
				const pos = contentEditor.selectionStart;
				// 如果刚输入回车，且当前位置在行首，则自动插入一个TAB
				if (pos > 1 && value[pos - 1] !== '\t' && value[pos - 2] === '\n') {
					contentEditor.value = value.slice(0, pos) + '\t' + value.slice(pos);
					contentEditor.selectionStart = contentEditor.selectionEnd = pos + 1;
				}
				isModified = true;
				updateStatus();

				// 添加到历史记录
				addToHistory(contentEditor.value);
			});

			// 工具栏编辑按钮 - 仅用于编辑标题
			document.getElementById('edit-title-btn').addEventListener('click', () => {
				if (activeTitleIndex === -1) {
					alert('请先选择要编辑的标题');
					return;
				}
				const newTitle = prompt('编辑标题:', documents[activeTitleIndex].title);
				if (newTitle && newTitle !== documents[activeTitleIndex].title) {
					documents[activeTitleIndex].title = newTitle;
					isModified = true;
					renderTitles();
					updateStatus();
				}
			});

			// 字体样式选择事件
			fileInput.addEventListener('change', function (event) {
				handleFileOpen(event);
				fileInput.value = ''; // 允许重复选择同一个文件
			});
			// 修改这一行，使用防抖版本的updateStatus
			contentEditor.addEventListener('input', debouncedUpdateStatus);

			// 初始化编辑器状态
			function initEditor() {
				// 确保DOM元素已加载
				if (!window.contentEditor || !window.statusInfo) {
					console.error('contentEditor 或 statusInfo 未正确初始化');
					return;
				}

				// 构建文档文本的函数
				function buildDocumentText() {
					let fullText = '';
					documents.forEach(doc => {
						fullText += `**${doc.title}**\n\n${doc.content}\n\n`;
					});
					return fullText;
				}

				// 设置自动保存定时器
				setInterval(() => {
					if (documents.length > 0 && activeTitleIndex !== -1) {
						documents[activeTitleIndex].content = window.contentEditor.value;
						localStorage.setItem('textEditorDocument', buildDocumentText());
					}
				}, 30000);

				// 检查当前文档是否有修改，必要时弹窗提示
				function checkAndSaveIfNeeded(callback) {
					if (window.isModified) {
						if (confirm('当前文档有修改，是否保存？')) {
							saveDocument();
						}
					}
					// 无论是否保存，都继续后续操作
					if (typeof callback === 'function') callback();
				}

				// 新建文档
				function newDocument() {
					checkAndSaveIfNeeded(function () {
						// 新建文档的实际逻辑
						const newTitle = prompt('请输入新标题:', '新标题');
						if (newTitle) {
							documents.push({
								title: newTitle,
								content: ''
							});
							activeTitleIndex = documents.length - 1;
							renderTitles();
							contentEditor.value = '';
							updateStatus();
							isModified = false; // 新文档未修改
						}
					});
				}

				document.getElementById('add-title-btn').addEventListener('click', newDocument);
				document.getElementById('new-btn').addEventListener('click', newDocument);
				// 创建默认新文档
				newDocument();
				isModified = false;

				// 初始化历史记录
				if (contentEditor) {
					window.editorHistory.records = [contentEditor.value];
				}
			}

			// 处理文件打开操作
			function handleFileOpen(event) {
				console.log('文件选择事件触发');
				try {
					const file = event.target.files[0];
					if (!file) {
						console.log('未选择文件');
						return;
					}

					console.log('开始读取文件:', file.name);
					const reader = new FileReader();

					reader.onload = function (e) {
						console.log('文件读取成功');
						try {
							const text = e.target.result;
							console.log('解析文档内容');
							parseDocument(text);

							console.log('更新界面');
							// 确保渲染前内容已更新
							if (documents.length > 0 && activeTitleIndex >= 0) {
								renderTitles();
								contentEditor.value = documents[activeTitleIndex].content;
								updateStatus();
								console.log('界面更新完成');

								// 重置历史记录
								window.editorHistory.records = [contentEditor.value];
								window.editorHistory.index = 0;

								// 显示成功提示
								addStatusMessage(`文件 "${file.name}" 加载成功`);
							} else {
								console.error('文档解析失败，未生成有效内容');
								alert('文档解析失败，请检查文件格式');
							}
						} catch (parseError) {
							console.error('文档处理错误:', parseError);
							alert('文档处理错误: ' + parseError.message);
						}
					};

					reader.onerror = function (error) {
						console.error('文件读取失败:', error);
						alert('文件读取失败: ' + error.target.error.message);
					};

					reader.readAsText(file);
				} catch (error) {
					console.error('文件打开异常:', error);
					alert('文件打开异常: ' + error.message);
				}
			}

			// 保存文档
			function saveDocument() {
				if (activeTitleIndex === -1 || documents.length === 0) return;

				if (isModified) {
					// 更新当前活动内容
					documents[activeTitleIndex].content = contentEditor.value;
					isModified = false;

					// 构建文档内容
					let fullText = '';
					documents.forEach(doc => {
						fullText += `**${doc.title}**\n\n${doc.content}\n\n`;
					});

					// 创建下载链接
					const blob = new Blob([fullText], { type: 'text/plain' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'document.txt';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);

					updateStatus();
					alert('文档已保存');
				} else {
					alert('文档没有修改，无需保存');
				}
			}

			// 关闭当前文档
			function closeDocument() {

				if (isModified) {
					if (confirm('文档已修改，确定要关闭吗？所有未保存的更改将丢失。')) {
						newDocument();
						isModified = false;
					}
				} else {
					newDocument();
				}
			}

			// 添加到历史记录
			function addToHistory(content) {
				// 添加新状态到历史记录
				window.editorHistory.add(content);

				// 如果当前不是最新状态，删除当前之后的所有历史
				if (window.editorHistory.index < window.editorHistory.records.length - 1) {
					window.editorHistory.records = window.editorHistory.records.slice(0, window.editorHistory.index + 1);
				}
			}

			// 撤销操作
			function undo() {
				if (window.editorHistory.index > 0) {
					window.editorHistory.index--;
					contentEditor.value = window.editorHistory.records[window.editorHistory.index];
					isModified = true;
					updateStatus();
				}
			}

			// 重做操作
			function redo() {
				if (window.editorHistory.index < window.editorHistory.records.length - 1) {
					window.editorHistory.index++;
					contentEditor.value = window.editorHistory.records[window.editorHistory.index];
					isModified = true;
					updateStatus();
				}
			}

			// 添加键盘快捷键支持
			contentEditor.addEventListener('keydown', function (e) {
				// 撤销: Ctrl+Z
				if (e.ctrlKey && e.key === 'z') {
					e.preventDefault();
					undo();
				}

				// 重做: Ctrl+Y
				if (e.ctrlKey && e.key === 'y') {
					e.preventDefault();
					redo();
				}

				// Tab键支持
				if (e.key === 'Tab') {
					e.preventDefault();
					const start = this.selectionStart;
					const end = this.selectionEnd;

					// 在光标位置插入Tab
					this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);

					// 将光标移到插入的Tab之后
					this.selectionStart = this.selectionEnd = start + 1;

					// 标记为已修改
					isModified = true;
					updateStatus();
				}
			});

			// 添加全局键盘快捷键
			document.addEventListener('keydown', function (e) {
				// 搜索: Ctrl+F
				if (e.ctrlKey && e.key === 'f') {
					e.preventDefault();
					toggleSearchDialog();
				}

				// 查找下一个: F3
				if (e.key === 'F3' && !e.shiftKey) {
					e.preventDefault();
					findNextMatch();
				}

				// 查找上一个: Shift+F3
				if (e.key === 'F3' && e.shiftKey) {
					e.preventDefault();
					findPreviousMatch();
				}
			});

			// 显示/隐藏搜索对话框
			// 搜索相关变量
			let searchDialogEventsInitialized = false;
			let searchResults = [];
			let currentResultIndex = -1;

			// 更新搜索结果信息
			function updateSearchResultInfo(message) {
				const resultInfo = document.getElementById('search-result-info');
				resultInfo.textContent = message;
			}

			// 查找文本
			function escapeRegExp(string) {
				return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
			}

			// 查找下一个匹配项
			function loadDocument(index) {
				if (index >= 0 && index < documents.length) {
					// 保存当前文档内容
					if (activeTitleIndex !== -1) {
						documents[activeTitleIndex].content = contentEditor.value;
					}

					// 切换到新文档
					activeTitleIndex = index;
					contentEditor.value = documents[index].content;

					// 重置查找状态
					searchResults = [];
					currentResultIndex = -1;

					// 更新标题列表高亮
					renderTitles();

					// 重置历史记录
					window.editorHistory.records = [contentEditor.value];
					window.editorHistory.index = 0;

					// 更新状态栏
					updateStatus();
				}
			}
			// 关闭搜索对话框
			function closeSearch() {
				searchResults = [];
				currentResultIndex = -1;

				const searchDialog = document.getElementById('search-dialog');
				if (searchDialog) {
					searchDialog.classList.remove('active');
				}
			}

			// 关闭搜索对话框
			function closeSearchDialog() {
				const searchDialog = document.getElementById('search-dialog');
				searchDialog.classList.remove('active');

				// 重置搜索结果
				searchResults = [];
				currentResultIndex = -1;

			}

			// ================== 标题栏相关功能 ==================

			// 渲染标题列表
			function renderTitles() {
				console.log('renderTitles called');
				titleList.innerHTML = '';
				documents.forEach((doc, index) => {
					const titleElement = document.createElement('div');
					titleElement.className = 'title-item';
					if (index === activeTitleIndex) {
						titleElement.classList.add('active');
					}

					// 直接设置标题文本，不创建编辑按钮
					titleElement.textContent = doc.title;
					titleElement.addEventListener('click', () => {
						setActiveTitle(index);
					});

					titleList.appendChild(titleElement);
				});
			}

			// 编辑标题
			function editTitle(index) {
				const newTitle = prompt('编辑标题:', documents[index].title);
				if (newTitle && newTitle.trim() !== '') {
					documents[index].title = newTitle.trim();
					renderTitles();
				}
			}

			// 设置活动标题
			function setActiveTitle(index) {
				if (index < 0 || index >= documents.length) {
					console.error('无效的标题索引:', index);
					return;
				}

				if (activeTitleIndex !== -1) {
					// 保存当前内容
					documents[activeTitleIndex].content = contentEditor.value;
					isModified = true;
				}

				activeTitleIndex = index;
				renderTitles();
				contentEditor.value = documents[index].content;

				// 重置历史记录
				window.editorHistory.records = [contentEditor.value];
				window.editorHistory.index = 0;

				// 触发内容更新事件
				const event = new Event('input');
				contentEditor.dispatchEvent(event);

				updateStatus();
			}

			// 添加新的标题
			function addTitle() {
				const newTitle = prompt('请输入新标题:', '新标题');
				if (newTitle) {
					documents.push({
						title: newTitle,
						content: ''
					});
					activeTitleIndex = documents.length - 1;
					renderTitles();
					contentEditor.value = '';
					updateStatus();
					isModified = false; // 新文档未修改
				}
			}

			// 移除当前选中的标题
			function removeTitle() {
				if (activeTitleIndex === -1 || documents.length <= 1) return;

				if (confirm(`确定要删除标题 "${documents[activeTitleIndex].title}" 吗？`)) {
					documents.splice(activeTitleIndex, 1);
					activeTitleIndex = activeTitleIndex >= documents.length ? documents.length - 1 : activeTitleIndex;
					renderTitles();
					contentEditor.value = activeTitleIndex >= 0 ? documents[activeTitleIndex].content : '';
					updateStatus();
				}
			}

			// 标题上移
			function moveTitleUp() {
				if (activeTitleIndex <= 0) return;

				const temp = documents[activeTitleIndex - 1];
				documents[activeTitleIndex - 1] = documents[activeTitleIndex];
				documents[activeTitleIndex] = temp;
				activeTitleIndex--;
				renderTitles();
			}

			// 标题下移
			function moveTitleDown() {
				if (activeTitleIndex >= documents.length - 1) return;

				const temp = documents[activeTitleIndex + 1];
				documents[activeTitleIndex + 1] = documents[activeTitleIndex];
				documents[activeTitleIndex] = temp;
				activeTitleIndex++;
				renderTitles();
			}

		});

		// ================== 搜索与替换功能 ==================

		// 显示或隐藏搜索弹窗
		function toggleSearchDialog() {
			const searchDialog = document.getElementById('search-dialog');
			if (!searchDialog) {
				console.error('search-dialog 元素未找到！');
				return;
			}
			searchDialog.classList.toggle('active');

			if (searchDialog.classList.contains('active')) {
				// 清除之前的搜索内容和结果
				document.getElementById('search-input').value = '';
				document.getElementById('replace-input').value = '';
				document.getElementById('search-result-info').textContent = '';
				searchResults = [];
				currentResultIndex = -1;

				// 聚焦搜索输入框
				document.getElementById('search-input').focus();

				// 初始化拖拽功能
				setupDialogDrag(searchDialog);

				// 只在第一次打开时添加事件监听器
				if (!searchDialogEventsInitialized) {
					// 添加搜索对话框按钮事件监听器
					document.getElementById('find-btn').addEventListener('click', findText);
					document.getElementById('find-prev-btn').addEventListener('click', findPreviousMatch);
					document.getElementById('find-next-btn').addEventListener('click', findNextMatch);
					document.getElementById('replace-btn').addEventListener('click', replaceText);
					document.getElementById('replace-all-btn').addEventListener('click', replaceAllText);
					// 添加关闭按钮事件
					document.getElementById('close-search-btn').addEventListener('click', closeSearchDialog);
					// 添加搜索范围按钮事件
					document.querySelectorAll('.scope-btn').forEach(btn => {
						btn.addEventListener('click', function () {
							document.querySelectorAll('.scope-btn').forEach(b => b.classList.remove('active'));
							this.classList.add('active');
						});
					});

					// 添加搜索输入框的回车键事件
					document.getElementById('search-input').addEventListener('keydown', function (e) {
						if (e.key === 'Enter') {
							e.preventDefault();
							if (e.shiftKey) {
								findPreviousMatch();
							} else {
								findNextMatch();
							}
						}
					});

					// 标记为已初始化
					searchDialogEventsInitialized = true;
				}
			}
		}

		// 查找文本并高亮或跳转
		function findText() {
			const searchDialog = document.getElementById('search-dialog');
			if (!searchDialog || !searchDialog.classList.contains('active')) {
				console.error('❌ 搜索对话框未显示或未激活！');
				return;
			}

			const searchInput = document.getElementById('search-input');
			if (!searchInput) {
				console.error('❌ search-input 元素未找到！请确保搜索对话框已显示。');
				return;
			}

			const searchText = searchInput.value;
			if (!searchText || /^\s*$/.test(searchText)) {
				updateSearchResultInfo('请输入要查找的文本');
				return;
			}

			const searchScopeBtn = document.querySelector('.scope-btn.active');
			if (!searchScopeBtn) {
				updateSearchResultInfo('请选择搜索范围（当前视图/整个文档）。');
				return;
			}
			const searchScope = searchScopeBtn.dataset.scope;

			const caseSensitive = document.getElementById('case-sensitive').checked;
			const wholeWord = document.getElementById('whole-word').checked;

			searchResults = [];
			currentResultIndex = -1;

			let flags = caseSensitive ? 'g' : 'gi';
			let searchPattern = searchText;

			if (wholeWord) {
				searchPattern = `\\b${searchPattern}\\b`;
			} else {
				searchPattern = escapeRegExp(searchPattern);
			}

			try {
				const regex = new RegExp(searchPattern, flags);

				if (searchScope === 'all') {
					// 搜索整个文档
					documents.forEach((doc, docIndex) => {
						const docContent = doc.content;
						let match;
						while ((match = regex.exec(docContent)) !== null) {
							searchResults.push({
								start: match.index,
								end: match.index + match[0].length,
								text: match[0],
								docIndex: docIndex
							});
						}
						regex.lastIndex = 0; // 重置正则表达式
					});
				} else {
					// 只搜索当前视图
					const docContent = contentEditor.value;
					let match;
					while ((match = regex.exec(docContent)) !== null) {
						searchResults.push({
							start: match.index,
							end: match.index + match[0].length,
							text: match[0],
							docIndex: activeTitleIndex
						});
					}
				}

				if (searchResults.length > 0) {
					updateSearchResultInfo(`找到 ${searchResults.length} 个匹配项`);
					currentResultIndex = 0;
					findNextMatch();
				} else {
					updateSearchResultInfo('未找到匹配项');
				}
			} catch (error) {
				updateSearchResultInfo(`搜索错误: ${error.message}`);
			}

			addToHistory(contentEditor.value);
		}

		// 查找下一个匹配项
		function findNextMatch() {
			if (searchResults.length === 0) {
				findText();
				return;
			}

			const searchScopeBtn = document.querySelector('.scope-btn.active');
			const searchScope = searchScopeBtn ? searchScopeBtn.dataset.scope : 'current';

			if (currentResultIndex === -1) {
				currentResultIndex = 0;
			} else {
				currentResultIndex = (currentResultIndex + 1) % searchResults.length;
			}

			let result = searchResults[currentResultIndex];

			// 只在"整个文档"搜索时检查文档切换
			if (searchScope === 'all' && activeTitleIndex !== -1 && documents.length > 1) {
				// 自动切换到匹配项所在标题
				if (result.docIndex !== activeTitleIndex) {
					setActiveTitle(result.docIndex);
					// setActiveTitle 会触发内容切换和渲染
				}
			}

			// 定位到匹配项
			contentEditor.focus();
			contentEditor.setSelectionRange(result.start, result.end);

			// 平滑滚动
			const scrollPos = Math.max(0, result.start / contentEditor.value.length * contentEditor.scrollHeight - 100);
			contentEditor.scrollTo({
				top: scrollPos,
				behavior: 'smooth'
			});

			// 更新状态信息
			const resultInfo = searchScope === 'current'
				? `匹配项 ${currentResultIndex + 1} / ${searchResults.length}`
				: `匹配项 ${currentResultIndex + 1} / ${searchResults.length} (文档: ${documents[activeTitleIndex].title})`;

			updateSearchResultInfo(resultInfo);
		}

		// 查找上一个匹配项
		function findPreviousMatch() {
			if (searchResults.length === 0) {
				findText();
				return;
			}

			const searchScopeBtn = document.querySelector('.scope-btn.active');
			const searchScope = searchScopeBtn ? searchScopeBtn.dataset.scope : 'current';

			currentResultIndex = (currentResultIndex - 1 + searchResults.length) % searchResults.length;
			let result = searchResults[currentResultIndex];

			// 只在"整个文档"搜索时检查文档切换
			if (searchScope === 'all' && activeTitleIndex !== -1 && documents.length > 1) {
				// 自动切换到匹配项所在标题
				if (result.docIndex !== activeTitleIndex) {
					setActiveTitle(result.docIndex);
				}
			}

			contentEditor.focus();
			contentEditor.setSelectionRange(result.start, result.end);
			// 平滑滚动并确保高亮可见
			const scrollPos = Math.max(0, result.start / contentEditor.value.length * contentEditor.scrollHeight - 100);
			contentEditor.scrollTo({
				top: scrollPos,
				behavior: 'smooth'
			});

			// 更新状态信息
			const resultInfo = searchScope === 'current'
				? `匹配项 ${currentResultIndex + 1} / ${searchResults.length}`
				: `匹配项 ${currentResultIndex + 1} / ${searchResults.length} (文档: ${documents[activeTitleIndex].title})`;
			updateSearchResultInfo(resultInfo);
		}

		// 替换当前匹配项
		function replaceText() {
			if (searchResults.length === 0 || currentResultIndex === -1) {
				updateSearchResultInfo('没有选中的匹配项可替换');
				return;
			}

			const replaceInput = document.getElementById('replace-input').value;
			const result = searchResults[currentResultIndex];

			// 替换文本
			const content = contentEditor.value;
			contentEditor.value =
				content.substring(0, result.start) +
				replaceInput +
				content.substring(result.end);

			// 标记为已修改
			isModified = true;

			// 更新搜索结果
			const lengthDiff = replaceInput.length - result.text.length;

			// 更新后续搜索结果的位置
			for (let i = currentResultIndex + 1; i < searchResults.length; i++) {
				searchResults[i].start += lengthDiff;
				searchResults[i].end += lengthDiff;
			}

			// 移除当前结果
			searchResults.splice(currentResultIndex, 1);

			// 更新当前索引
			if (searchResults.length === 0) {
				currentResultIndex = -1;
				updateSearchResultInfo('替换完成，未找到更多匹配项');
			} else {
				currentResultIndex = Math.min(currentResultIndex, searchResults.length - 1);
				findNextMatch();
			}

			// 更新状态
			updateStatus();

			// 添加到历史记录
			addToHistory(contentEditor.value);
		}

		// 替换所有匹配项
		function replaceAllText() {
			const searchInput = document.getElementById('search-input').value;
			if (!searchInput) {
				updateSearchResultInfo('请输入要查找的文本');
				return;
			}

			const replaceInput = document.getElementById('replace-input').value;
			const content = contentEditor.value;
			const caseSensitive = document.getElementById('case-sensitive').checked;
			const wholeWord = document.getElementById('whole-word').checked;

			// 创建正则表达式
			let flags = caseSensitive ? 'g' : 'gi';
			let searchPattern = searchInput;

			if (wholeWord) {
				searchPattern = `\\b${searchPattern}\\b`;
			}

			try {
				const regex = new RegExp(searchPattern, flags);

				// 替换所有匹配项
				const newContent = content.replace(regex, replaceInput);
				const replacedCount = (content.match(regex) || []).length;

				// 更新内容
				contentEditor.value = newContent;

				// 标记为已修改
				isModified = true;

				// 更新结果信息
				updateSearchResultInfo(`已替换 ${replacedCount} 个匹配项`);

				// 重置搜索结果
				searchResults = [];
				currentResultIndex = -1;

				// 更新状态
				updateStatus();

				// 添加到历史记录
				addToHistory(contentEditor.value);
			} catch (error) {
				updateSearchResultInfo(`替换错误: ${error.message}`);
			}
		}

		// ================== 状态栏与消息 ==================

		// 防抖后更新状态栏统计信息
		const debouncedUpdateStatus = debounce(function () {
			// 安全访问依赖变量
			if (typeof activeTitleIndex === 'undefined' || activeTitleIndex === -1) return;
			if (!window.contentEditor || !window.statusInfo || !documents) return;

			const text = contentEditor.value;
			const lines = text.split('\n').length;
			// 当前页非空白字符数
			const currentCount = text.replace(/\s/g, '').length;

			// 计算总字数（所有文档内容去除空白后的总长度）
			let totalCount = 0;
			documents.forEach(doc => {
				const docText = doc.content.replace(/\s/g, '');
				totalCount += docText.length;
			});

			window.statusInfo.textContent = `行: ${lines} | 当前字数: ${currentCount} | 总字数: ${totalCount}`;
		}, 300);

		// 添加临时状态消息
		function addStatusMessage(message) {
			// 消息显示时间（毫秒）
			const MESSAGE_TIMEOUT = 5000;
			const statusMessages = document.getElementById('status-messages');
			if (!statusMessages) {
				console.warn('状态消息容器未找到，请确保存在 id="status-messages" 的元素');
				return;
			}

			const messageElement = document.createElement('span');
			messageElement.className = 'status-message';
			messageElement.textContent = message;
			statusMessages.appendChild(messageElement);

			// 自动移除消息
			const timeoutId = setTimeout(() => {
				messageElement.remove();
			}, MESSAGE_TIMEOUT);

			// 清理定时器
			messageElement.dataset.timeoutId = timeoutId;
		}

		// ================== 其它辅助函数 ==================

		// 防抖函数，避免高频操作
		function debounce(func, wait) {
			let timeout;
			return function () {
				clearTimeout(timeout);
				timeout = setTimeout(func, wait);
			};
		}

		// 弹窗拖拽功能
		function setupDialogDrag(dialog) {
			const header = dialog.querySelector('.dialog-header');
			if (!header) return;

			let isDragging = false;
			let offsetX, offsetY;

			header.addEventListener('mousedown', (e) => {
				isDragging = true;
				offsetX = e.clientX - dialog.getBoundingClientRect().left;
				offsetY = e.clientY - dialog.getBoundingClientRect().top;
				dialog.style.cursor = 'grabbing';
				e.preventDefault();
			});

			document.addEventListener('mousemove', (e) => {
				if (!isDragging) return;

				let left = e.clientX - offsetX;
				let top = e.clientY - offsetY;

				// 限制不超出视口
				const maxLeft = window.innerWidth - dialog.offsetWidth;
				const maxTop = window.innerHeight - dialog.offsetHeight;

				left = Math.max(0, Math.min(left, maxLeft));
				top = Math.max(0, Math.min(top, maxTop));

				dialog.style.left = left + 'px';
				dialog.style.top = top + 'px';
				dialog.style.transform = 'none';
			});

			document.addEventListener('mouseup', () => {
				isDragging = false;
				dialog.style.cursor = '';
			});
		}

		// 解析文档内容为标题和正文
		function parseDocument(text) {
			documents = [];
			let currentPos = 0;

			// 使用matchAll一次性找到所有标题
			const titleMatches = [...text.matchAll(/(\*\*(.+?)\*\*|\*\*\s(.+?)\s\*\*|\[(.+?)\]|【(.+?)】)/g)];

			if (titleMatches.length === 0) {
				// 如果没有标题，整个文档作为一个未命名标题
				documents.push({
					title: "未命名标题",
					content: addTabToParagraphs(text.trim())
				});
				activeTitleIndex = 0;
				return;
			}

			// 处理第一个标题之前的内容
			if (titleMatches[0].index > 0) {
				const initialContent = text.substring(0, titleMatches[0].index).trim();
				if (initialContent) {
					documents.push({
						title: "未命名标题",
						content: addTabToParagraphs(initialContent)
					});
				}
			}

			// 处理每个标题及其内容
			for (let i = 0; i < titleMatches.length; i++) {
				const match = titleMatches[i];
				const title = match[2] || match[3] || match[4];

				// 计算当前标题内容的结束位置
				let contentEnd = text.length;
				if (i < titleMatches.length - 1) {
					// 如果不是最后一个标题，内容结束于下一个标题的开始
					contentEnd = titleMatches[i + 1].index;
				}

				// 提取当前标题的内容
				const content = text.substring(match.index + match[0].length, contentEnd).trim();

				// 添加到文档列表
				documents.push({
					title: title.trim(),
					content: addTabToParagraphs(content)
				});
			}

			activeTitleIndex = 0;
		}

		// 新增：为每个段落开头加TAB
		function addTabToParagraphs(text) {
			// 以换行分段，非空行前加\t
			return text.split('\n').map(line => line.trim() ? '\t' + line.trim() : '').join('\n');
		}
	</script>
</body>

</html>