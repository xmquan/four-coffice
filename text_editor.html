<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>åŒæ æ–‡æœ¬ç¼–è¾‘å™¨</title>

	<!-- CSSæ ·å¼éƒ¨åˆ† -->
	<style>
		/* å…¨å±€å˜é‡ */
		:root {
			/* é¢œè‰² */
			--bg-color: #f5f5f5;
			--toolbar-color: #e0e0e0;
			--border-color: #bdbdbd;
			--text-color: #333;
			--highlight-color: #90caf9;

			/* é—´è· */
			--base-padding: 8px;
			--small-padding: 4px;

			/* é˜´å½± */
			--base-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			--hover-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
			--active-shadow: 0 4px 8px rgba(144, 202, 249, 0.3);
		}

		/* åŸºç¡€æ ·å¼ */
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 0;
			padding: 0;
			background-color: var(--bg-color);
			color: var(--text-color);
			height: 100vh;
			display: flex;
			flex-direction: column;
		}

		/* å·¥å…·æ æ ·å¼ - é¡¶éƒ¨æ“ä½œæŒ‰é’®åŒºåŸŸ */
		.toolbar {
			background-color: var(--toolbar-color);
			padding: var(--base-padding);
			border-bottom: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
			gap: var(--base-padding);
		}

		.toolbar-row {
			display: flex;
			justify-content: space-between;
		}

		.tool-group {
			display: flex;
			gap: var(--base-padding);
		}

		button {
			padding: 6px 12px;
			background-color: white;
			border: 1px solid var(--border-color);
			border-radius: var(--small-padding);
			cursor: pointer;
			transition: all 0.2s ease;
			min-width: 24px;
			text-align: center;
		}

		button:hover {
			background-color: #eee;
			box-shadow: var(--base-shadow);
		}

		button:active {
			transform: translateY(0);
			box-shadow: none;
		}

		/* æ ¼å¼åŒ–æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
		#bold-btn,
		#italic-btn,
		#underline-btn,
		#strike-btn {
			font-weight: bold;
			font-family: 'Times New Roman', serif;
		}

		/* æœç´¢æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
		#search-btn {
			background-color: #f0f8ff;
			border-color: #90caf9;
			position: relative;
			padding-left: 24px;
		}

		#search-btn::before {
			content: "ğŸ”";
			position: absolute;
			left: var(--base-padding);
			top: 50%;
			transform: translateY(-50%);
			font-size: 14px;
		}

		#search-btn:hover {
			background-color: #e3f2fd;
			border-color: #64b5f6;
		}

		#bold-btn {
			font-weight: 900;
		}

		#italic-btn {
			font-style: italic;
		}

		#underline-btn {
			text-decoration: underline;
		}

		#strike-btn {
			text-decoration: line-through;
		}

		#link-btn,
		#image-btn,
		#code-btn {
			font-size: 14px;
			padding: 6px var(--base-padding);
		}

		.editor-container {
			display: flex;
			flex: 1;
			overflow: hidden;
		}

		.title-panel,
		.content-panel {
			flex: 1;
			display: flex;
			flex-direction: column;
			padding: var(--base-padding);
			overflow: hidden;
		}

		.title-panel {
			border-right: 1px solid var(--border-color);
			max-width: 300px;
		}

		.panel-header {
			font-weight: bold;
			margin-bottom: var(--base-padding);
		}

		/* ç¼–è¾‘å™¨æ ·å¼ */
		.editor {
			flex: 1;
			border: 1px solid var(--border-color);
			background-color: white;
			padding: var(--base-padding);
			overflow-y: scroll;
			outline: none;
			scrollbar-width: thin;
			scrollbar-color: #c1c1c1 #f1f1f1;
		}

		/* æ»šåŠ¨æ¡æ ·å¼ */
		.editor::-webkit-scrollbar {
			width: 18px;
			height: 18px;
			display: block;
		}

		.editor::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 9px;
			box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
		}

		.editor::-webkit-scrollbar-thumb {
			background-color: #c1c1c1;
			border-radius: 9px;
			border: 3px solid #f1f1f1;
		}

		.editor::-webkit-scrollbar-thumb:hover {
			background-color: #a8a8a8;
		}

		/* ç¡®ä¿å†…å®¹è¶³å¤Ÿè§¦å‘æ»šåŠ¨æ¡ */
		#title-list {
			min-height: 200px;
			/* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´æ˜¾ç¤ºæ»šåŠ¨æ¡ */
		}

		#content-editor {
			min-height: 300px;
			/* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´æ˜¾ç¤ºæ»šåŠ¨æ¡ */
			resize: none;
			/* ç¦æ­¢é€šè¿‡é¼ æ ‡è°ƒæ•´å¤§å° */
		}

		/* çŠ¶æ€æ æ ·å¼ */
		.status-bar {
			height: auto;
			min-height: 24px;
			font-size: 12px;
			padding: var(--small-padding) var(--base-padding);
			background-color: var(--toolbar-color);
			border-top: 1px solid var(--border-color);
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			overflow-x: auto;
			white-space: nowrap;
		}

		.status-item {
			margin-right: var(--base-padding);
			display: inline-flex;
			align-items: center;
		}

		.status-saved {
			margin-left: var(--base-padding);
			color: #4CAF50;
			transition: all 0.3s ease;
			opacity: 1;
		}

		.status-messages {
			flex: 1;
			display: flex;
			flex-wrap: wrap;
			margin-right: 10px;
			overflow: hidden;
		}

		.status-message {
			background-color: rgba(144, 202, 249, 0.2);
			border-radius: var(--small-padding);
			padding: 2px 6px;
			margin-right: 5px;
			margin-bottom: 3px;
			white-space: nowrap;
		}

		.status-stats {
			flex-shrink: 0;
			text-align: right;
		}

		/* å“åº”å¼è®¾è®¡ */
		@media (max-width: 768px) {
			.status-bar {
				font-size: 11px;
			}

			.status-item {
				margin-right: var(--small-padding);
			}
		}

		/* æ ‡é¢˜é¡¹æ ·å¼ */
		.title-item {
			padding: 12px;
			margin-bottom: var(--base-padding);
			cursor: pointer;
			border-radius: var(--base-padding);
			background-color: white;
			box-shadow: 0 2px var(--small-padding) rgba(0, 0, 0, 0.1);
			transition: all 0.2s ease;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.title-item:hover {
			background-color: #f5f5f5;
			box-shadow: 0 var(--small-padding) var(--base-padding) rgba(0, 0, 0, 0.15);
		}

		.title-item.active {
			background-color: var(--highlight-color);
			box-shadow: 0 var(--small-padding) var(--base-padding) rgba(144, 202, 249, 0.3);
			border-left: var(--small-padding) solid #1976d2;
		}

		.title-item {

			font-weight: 500;
		}

		/* ç§»é™¤ç¼–è¾‘æŒ‰é’®ç›¸å…³æ ·å¼ */
		input[type="file"] {
			display: none;
		}

		/* æœç´¢å’Œæ›¿æ¢å¯¹è¯æ¡†æ ·å¼ */
		.search-dialog {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 400px;
			max-height: 80vh;
			background-color: var(--bg-color);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			border-radius: var(--base-padding);
			box-shadow: 0 var(--small-padding) 12px rgba(0, 0, 0, 0.15);
			padding: 20px;
			z-index: 1000;
			display: none;
			overflow-y: auto;
		}

		.search-dialog .dialog-header {
			padding: var(--base-padding) 16px;
			margin: -20px -20px 10px -20px;
			background: var(--toolbar-color);
			border-radius: var(--base-padding) var(--base-padding) 0 0;
			cursor: move;
			user-select: none;
		}

		.search-dialog.active {
			display: block;
		}

		.search-dialog .close-button {
			position: absolute;
			right: 12px;
			top: 16px;
			font-size: 20px;
			color: #aaa;
			cursor: pointer;
			transform: scale(0.8) translateX(2px);
			transition: 0.2s ease;
		}

		.search-dialog .search-header {
			margin-top: 0;
			margin-bottom: 12px;
			font-size: 16px;
			font-weight: bold;
			color: var(--text-color);
			border-bottom: 1px solid var(--border-color);
			padding-bottom: var(--base-padding);
		}

		.search-dialog .search-content {
			padding: var(--base-padding) 0;
		}

		.search-dialog .form-group {
			margin-bottom: 12px;
		}

		.search-dialog label {
			display: block;
			margin-bottom: var(--small-padding);
			font-size: 14px;
		}

		.search-dialog input[type="text"] {
			width: 96%;
			padding: 6px var(--base-padding);
			border: 1px solid var(--border-color);
			border-radius: var(--small-padding);
			font-size: 14px;
		}

		.search-dialog .options {
			display: flex;
			margin-bottom: 12px;
		}

		.search-dialog .option {
			margin-right: 12px;
			font-size: 14px;
		}

		.search-dialog .buttons {
			display: flex;
			flex-wrap: wrap;
			gap: 5px;
			justify-content: space-between;
		}

		.search-dialog .buttons button,
		.search-dialog .scope-btn {
			padding: var(--small-padding) var(--base-padding);
			font-size: 12px;
			border: 1px solid var(--border-color);
			border-radius: var(--base-radius);
			background-color: white;
			cursor: pointer;
			transition: var(--base-transition);
		}

		.search-dialog .scope-btn.active {
			background-color: var(--highlight-color);
			border-color: var(--highlight-color);
			color: white;
		}

		.search-dialog .result-info {
			font-size: 12px;
			margin-top: var(--base-padding);
			color: #666;
		}

		/* æœç´¢é«˜äº®æ ·å¼ */
		.highlight-container {
			position: absolute;
			pointer-events: none;
			z-index: 5;
			overflow: hidden;
		}

		/* æ™®é€šåŒ¹é…é¡¹ */
		.highlight-overlay {
			background-color: yellow;

		}

		/* å½“å‰é€‰ä¸­åŒ¹é…é¡¹ */
		.highlight-current {
			background-color: orange;

		}
	</style>
</head>

<body>
	<div class="toolbar">
		<div class="toolbar-row">
			<!-- å·¥å…·æ å…ƒç´ -->
			<div class="tool-group">
				<button id="new-btn">æ–°å»º</button>
				<button id="open-btn">æ‰“å¼€</button>
				<input type="file" id="file-input" accept=".txt" style="display:none">
				<button id="save-btn">ä¿å­˜</button>
				<button id="close-btn">å…³é—­</button>
			</div>
		</div>
		<div class="toolbar-row">
			<!-- æ ‡é¢˜æ å…ƒç´  -->
			<div class="tool-group">
				<button id="add-title-btn">å¢åŠ </button>
				<button id="remove-title-btn">ç§»é™¤</button>
				<button id="edit-title-btn">ç¼–è¾‘</button>
				<button id="move-up-btn">ä¸Šç§»</button>
				<button id="move-down-btn">ä¸‹ç§»</button>
			</div>
			<!-- å†…å®¹æ å…ƒç´  -->
			<div class="content-tools">
				<button id="font-size-btn">å­—å·</button>
				<button id="line-height-btn">è¡Œè·</button>
				<button id="letter-spacing-btn">åˆ—è·</button>
				<button id="search-btn">æœç´¢</button>
			</div>
		</div>
	</div>

	<!-- ä¸»å†…å®¹åŒº -->
	<div class="editor-container">
		<!-- æ ‡é¢˜æ  -->
		<div class="title-panel">
			<div class="panel-header">æ ‡é¢˜</div>
			<div id="title-list" class="editor" contenteditable="false"></div>
		</div>
		<!-- å†…å®¹æ  -->
		<div class="content-panel">
			<div class="panel-header">å†…å®¹</div>
			<textarea id="content-editor" class="editor"></textarea>
			<div class="status-bar">
				<div class="status-messages" id="status-messages"></div>
				<div class="status-stats" id="status-info">è¡Œ: 0 | å­—æ•°: 0 | æ€»å­—æ•°: 0</div>
			</div>
		</div>
	</div>

	<!-- æœç´¢å’Œæ›¿æ¢å¯¹è¯æ¡† -->
	<div id="search-dialog" class="search-dialog">
		<div class="dialog-header">æœç´¢å’Œæ›¿æ¢</div>
		<div class="search-header">æœç´¢é€‰é¡¹</div>
		<div class="search-content">
			<div class="form-group">
				<label for="search-input">æŸ¥æ‰¾å†…å®¹:</label>
				<input type="text" id="search-input" placeholder="è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬">
			</div>
			<div class="form-group">
				<label for="replace-input">æ›¿æ¢ä¸º:</label>
				<input type="text" id="replace-input" placeholder="è¾“å…¥è¦æ›¿æ¢çš„æ–‡æœ¬">
			</div>
			<div class="options">
				<div class="option">
					<input type="checkbox" id="case-sensitive">
					<label for="case-sensitive">åŒºåˆ†å¤§å°å†™</label>
				</div>
				<div class="option">
					<input type="checkbox" id="whole-word">
					<label for="whole-word">å…¨å­—åŒ¹é…</label>
				</div>
				<div class="option">
					<button id="search-current" class="scope-btn " data-scope="current">å½“å‰è§†å›¾</button>
				</div>
				<div class="option">
					<button id="search-all" class="scope-btn active" data-scope="all">æ•´ä¸ªæ–‡æ¡£</button>
				</div>
			</div>
			<div class="buttons">
				<button id="find-btn">æŸ¥æ‰¾</button>
				<button id="find-prev-btn">ä¸Šä¸€ä¸ª</button>
				<button id="find-next-btn">ä¸‹ä¸€ä¸ª</button>
				<button id="replace-btn">æ›¿æ¢</button>
				<button id="replace-all-btn">å…¨éƒ¨æ›¿æ¢</button>
				<button id="close-search-btn">å…³é—­</button>
			</div>
			<div class="result-info" id="search-result-info"></div>
		</div>
	</div>

	<!-- JavaScriptåŠŸèƒ½å®ç° -->
	<script>
		// å…¨å±€å˜é‡ï¼šå­˜å‚¨æ‰€æœ‰æ–‡æ¡£
		window.documents = [];

		// å…¨å±€å˜é‡ï¼šå½“å‰æ¿€æ´»çš„æ ‡é¢˜ç´¢å¼•
		window.activeTitleIndex = -1;

		// å…¨å±€å˜é‡ï¼šæ ‡è®°æ–‡æ¡£æ˜¯å¦è¢«ä¿®æ”¹
		window.isModified = false;
		// å…¨å±€å†å²è®°å½•ç³»ç»Ÿ
		window.editorHistory = {
			records: [""],
			index: 0,
			MAX: 100,

			// æ·»åŠ å†å²è®°å½•æ–¹æ³•
			add: function (content) {
				if (this.index < this.records.length - 1) {
					this.records = this.records.slice(0, this.index + 1);
				}
				this.records.push(content);
				this.index = this.records.length - 1;

				// é™åˆ¶å†å²è®°å½•æ•°é‡
				if (this.records.length > this.MAX) {
					this.records.shift();
					this.index--;
				}
			}
		};

		// å¼¹çª—æ‹–æ‹½åŠŸèƒ½
		function setupDialogDrag(dialog) {
			const header = dialog.querySelector('.dialog-header');
			if (!header) return;

			let isDragging = false;
			let offsetX, offsetY;

			header.addEventListener('mousedown', (e) => {
				isDragging = true;
				offsetX = e.clientX - dialog.getBoundingClientRect().left;
				offsetY = e.clientY - dialog.getBoundingClientRect().top;
				dialog.style.cursor = 'grabbing';
				e.preventDefault();
			});

			document.addEventListener('mousemove', (e) => {
				if (!isDragging) return;

				let left = e.clientX - offsetX;
				let top = e.clientY - offsetY;

				// é™åˆ¶ä¸è¶…å‡ºè§†å£
				const maxLeft = window.innerWidth - dialog.offsetWidth;
				const maxTop = window.innerHeight - dialog.offsetHeight;

				left = Math.max(0, Math.min(left, maxLeft));
				top = Math.max(0, Math.min(top, maxTop));

				dialog.style.left = left + 'px';
				dialog.style.top = top + 'px';
				dialog.style.transform = 'none';
			});

			document.addEventListener('mouseup', () => {
				isDragging = false;
				dialog.style.cursor = '';
			});
		}

		// é˜²æŠ–å‡½æ•°
		function debounce(func, wait) {
			let timeout;
			return function () {
				clearTimeout(timeout);
				timeout = setTimeout(func, wait);
			};
		}

		// é˜²æŠ–ç‰ˆæœ¬çš„çŠ¶æ€æ›´æ–°ï¼ˆæœ€å…ˆå®šä¹‰ï¼‰
		// æ·»åŠ çŠ¶æ€æ¶ˆæ¯
		function addStatusMessage(message) {
			const MESSAGE_TIMEOUT = 5000; // æ¶ˆæ¯æ˜¾ç¤ºæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
			const statusMessages = document.getElementById('status-messages');
			if (!statusMessages) {
				console.warn('çŠ¶æ€æ¶ˆæ¯å®¹å™¨æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å­˜åœ¨ id="status-messages" çš„å…ƒç´ ');
				return;
			}

			const messageElement = document.createElement('span');
			messageElement.className = 'status-message';
			messageElement.textContent = message;
			statusMessages.appendChild(messageElement);

			// è‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
			const timeoutId = setTimeout(() => {
				messageElement.remove();
			}, MESSAGE_TIMEOUT);

			// æ¸…ç†å®šæ—¶å™¨
			messageElement.dataset.timeoutId = timeoutId;
		}

		const debouncedUpdateStatus = debounce(function () {
			// å®‰å…¨è®¿é—®ä¾èµ–å˜é‡
			if (typeof activeTitleIndex === 'undefined' || activeTitleIndex === -1) return;
			if (!window.contentEditor || !window.statusInfo || !documents) return;

			const text = contentEditor.value;
			const lines = text.split('\n').length;
			const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;

			// è®¡ç®—æ€»å­—æ•°
			let totalWords = 0;
			documents.forEach(doc => {
				const docText = doc.content.replace(/<[^>]*>/g, '');
				totalWords += docText.trim() === '' ? 0 : docText.trim().split(/\s+/).length;
			});

			window.statusInfo.textContent = `æ ‡é¢˜: ${documents[activeTitleIndex].title} | è¡Œ: ${lines} | å­—æ•°: ${words} | æ€»å­—æ•°: ${totalWords}`;
		}, 300);

		// å…¨å±€updateStatuså‡½æ•°
		function updateStatus() {
			// ç¡®ä¿ä¾èµ–å˜é‡å·²åˆå§‹åŒ–
			if (typeof debouncedUpdateStatus !== 'undefined') {
				debouncedUpdateStatus();
			}
		}

		// å½“DOMå®Œå…¨åŠ è½½åæ‰§è¡Œåˆå§‹åŒ–
		document.addEventListener('DOMContentLoaded', function () {
			// è·å–å…³é”®DOMå…ƒç´ å¼•ç”¨			
			window.contentEditor = document.getElementById('content-editor');
			window.statusInfo = document.getElementById('status-info');
			const fileInput = document.getElementById('file-input');
			const titleList = document.getElementById('title-list');

			// å…¨å±€çŠ¶æ€å˜é‡
			// window.activeTitleIndex = -1; // å½“å‰æ´»åŠ¨æ ‡é¢˜ç´¢å¼•ï¼Œ-1è¡¨ç¤ºæœªé€‰æ‹©
			// window.documents = []; // å­˜å‚¨æ‰€æœ‰æ–‡æ¡£çš„æ ‡é¢˜å’Œå†…å®¹
			// window.isModified = false; // è·Ÿè¸ªæ–‡æ¡£æ˜¯å¦è¢«ä¿®æ”¹

			// åˆå§‹åŒ–ç¼–è¾‘å™¨ï¼Œè®¾ç½®åˆå§‹çŠ¶æ€
			initEditor();

			// é¡¶éƒ¨å·¥å…·æ æŒ‰é’®äº‹ä»¶ç»‘å®š
			document.getElementById('new-btn').addEventListener('click', newDocument);
			document.getElementById('open-btn').addEventListener('click', () => fileInput.click());
			document.getElementById('save-btn').addEventListener('click', saveDocument);
			document.getElementById('close-btn').addEventListener('click', closeDocument);
			// ç§»é™¤äº†ä¸å­˜åœ¨çš„æŒ‰é’®ï¼ˆundo-btn, redo-btn, export-btnï¼‰çš„äº‹ä»¶ç›‘å¬å™¨

			document.getElementById('add-title-btn').addEventListener('click', addTitle);
			document.getElementById('remove-title-btn').addEventListener('click', removeTitle);
			document.getElementById('move-up-btn').addEventListener('click', moveTitleUp);
			document.getElementById('move-down-btn').addEventListener('click', moveTitleDown);

			// æ·»åŠ å­—ä½“æ ·å¼æŒ‰é’®äº‹ä»¶
			document.getElementById('font-size-btn').addEventListener('click', changeFontSize);
			document.getElementById('line-height-btn').addEventListener('click', changeLineHeight);
			document.getElementById('letter-spacing-btn').addEventListener('click', changeLetterSpacing);
			document.getElementById('search-btn').addEventListener('click', toggleSearchDialog);

			// å·¥å…·æ ç¼–è¾‘æŒ‰é’® - ä»…ç”¨äºç¼–è¾‘æ ‡é¢˜
			document.getElementById('edit-title-btn').addEventListener('click', () => {
				if (activeTitleIndex === -1) {
					alert('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„æ ‡é¢˜');
					return;
				}
				const newTitle = prompt('ç¼–è¾‘æ ‡é¢˜:', documents[activeTitleIndex].title);
				if (newTitle && newTitle !== documents[activeTitleIndex].title) {
					documents[activeTitleIndex].title = newTitle;
					isModified = true;
					renderTitles();
					updateStatus();
				}
			});

			fileInput.addEventListener('change', handleFileOpen);
			// ä¿®æ”¹è¿™ä¸€è¡Œï¼Œä½¿ç”¨é˜²æŠ–ç‰ˆæœ¬çš„updateStatus
			contentEditor.addEventListener('input', debouncedUpdateStatus);

			// åˆå§‹åŒ–ç¼–è¾‘å™¨çŠ¶æ€
			function initEditor() {
				// ç¡®ä¿DOMå…ƒç´ å·²åŠ è½½
				if (!window.contentEditor || !window.statusInfo) {
					console.error('contentEditor æˆ– statusInfo æœªæ­£ç¡®åˆå§‹åŒ–');
					return;
				}

				// æ„å»ºæ–‡æ¡£æ–‡æœ¬çš„å‡½æ•°
				function buildDocumentText() {
					let fullText = '';
					documents.forEach(doc => {
						fullText += `**${doc.title}**\n\n${doc.content}\n\n`;
					});
					return fullText;
				}

				// è®¾ç½®è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
				setInterval(() => {
					if (documents.length > 0 && activeTitleIndex !== -1) {
						documents[activeTitleIndex].content = window.contentEditor.value;
						localStorage.setItem('textEditorDocument', buildDocumentText());
					}
				}, 30000);

				// ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡
				// const statusInfo = window.statusInfo; // å¦‚æœéœ€è¦å±€éƒ¨å¼•ç”¨ï¼Œå¯ä»¥è¿™æ ·è·å–

				// åˆ›å»ºé»˜è®¤æ–°æ–‡æ¡£
				newDocument();
				isModified = false;

				// åˆå§‹åŒ–å†å²è®°å½•
				if (contentEditor) {
					window.editorHistory.records = [contentEditor.value];
				}
				// window.editorHistory.index = 0;
			}

			// æ–°å»ºæ–‡æ¡£
			function newDocument() {
				documents = [{
					title: 'æœªå‘½åæ ‡é¢˜',
					content: ''
				}];
				activeTitleIndex = 0;
				renderTitles();
				contentEditor.value = '';
				isModified = false;

				// æ›´æ–°å†å²è®°å½•
				addToHistory(contentEditor.value);

				updateStatus();
			}

			// å¤„ç†æ–‡ä»¶æ‰“å¼€æ“ä½œ
			function handleFileOpen(event) {
				console.log('æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘');
				try {
					const file = event.target.files[0];
					if (!file) {
						console.log('æœªé€‰æ‹©æ–‡ä»¶');
						return;
					}

					console.log('å¼€å§‹è¯»å–æ–‡ä»¶:', file.name);
					const reader = new FileReader();

					reader.onload = function (e) {
						console.log('æ–‡ä»¶è¯»å–æˆåŠŸ');
						try {
							const text = e.target.result;
							console.log('è§£ææ–‡æ¡£å†…å®¹');
							parseDocument(text);

							console.log('æ›´æ–°ç•Œé¢');
							// ç¡®ä¿æ¸²æŸ“å‰å†…å®¹å·²æ›´æ–°
							if (documents.length > 0 && activeTitleIndex >= 0) {
								renderTitles();
								contentEditor.value = documents[activeTitleIndex].content;
								updateStatus();
								console.log('ç•Œé¢æ›´æ–°å®Œæˆ');

								// é‡ç½®å†å²è®°å½•
								window.editorHistory.records = [contentEditor.value];
								window.editorHistory.index = 0;

								// æ˜¾ç¤ºæˆåŠŸæç¤º
								addStatusMessage(`æ–‡ä»¶ "${file.name}" åŠ è½½æˆåŠŸ`);
							} else {
								console.error('æ–‡æ¡£è§£æå¤±è´¥ï¼Œæœªç”Ÿæˆæœ‰æ•ˆå†…å®¹');
								alert('æ–‡æ¡£è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
							}
						} catch (parseError) {
							console.error('æ–‡æ¡£å¤„ç†é”™è¯¯:', parseError);
							alert('æ–‡æ¡£å¤„ç†é”™è¯¯: ' + parseError.message);
						}
					};

					reader.onerror = function (error) {
						console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
						alert('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.target.error.message);
					};

					reader.readAsText(file);
				} catch (error) {
					console.error('æ–‡ä»¶æ‰“å¼€å¼‚å¸¸:', error);
					alert('æ–‡ä»¶æ‰“å¼€å¼‚å¸¸: ' + error.message);
				}
			}

			// è§£ææ–‡æ¡£å†…å®¹
			function parseDocument(text) {
				documents = [];
				let currentPos = 0;

				// ä½¿ç”¨matchAllä¸€æ¬¡æ€§æ‰¾åˆ°æ‰€æœ‰æ ‡é¢˜
				const titleMatches = [...text.matchAll(/(\*\*(.+?)\*\*|\*\*\s(.+?)\s\*\*|\[(.+?)\]|ã€(.+?)ã€‘)/g)];

				if (titleMatches.length === 0) {
					// å¦‚æœæ²¡æœ‰æ ‡é¢˜ï¼Œæ•´ä¸ªæ–‡æ¡£ä½œä¸ºä¸€ä¸ªæœªå‘½åæ ‡é¢˜
					documents.push({
						title: "æœªå‘½åæ ‡é¢˜",
						content: text.trim()
					});
					activeTitleIndex = 0;
					return;
				}

				// å¤„ç†ç¬¬ä¸€ä¸ªæ ‡é¢˜ä¹‹å‰çš„å†…å®¹
				if (titleMatches[0].index > 0) {
					const initialContent = text.substring(0, titleMatches[0].index).trim();
					if (initialContent) {
						documents.push({
							title: "æœªå‘½åæ ‡é¢˜",
							content: initialContent
						});
					}
				}

				// å¤„ç†æ¯ä¸ªæ ‡é¢˜åŠå…¶å†…å®¹
				for (let i = 0; i < titleMatches.length; i++) {
					const match = titleMatches[i];
					const title = match[2] || match[3] || match[4];

					// è®¡ç®—å½“å‰æ ‡é¢˜å†…å®¹çš„ç»“æŸä½ç½®
					let contentEnd = text.length;
					if (i < titleMatches.length - 1) {
						// å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªæ ‡é¢˜ï¼Œå†…å®¹ç»“æŸäºä¸‹ä¸€ä¸ªæ ‡é¢˜çš„å¼€å§‹
						contentEnd = titleMatches[i + 1].index;
					}

					// æå–å½“å‰æ ‡é¢˜çš„å†…å®¹
					const content = text.substring(match.index + match[0].length, contentEnd).trim();

					// æ·»åŠ åˆ°æ–‡æ¡£åˆ—è¡¨
					documents.push({
						title: title.trim(),
						content: content
					});
				}

				activeTitleIndex = 0;
			}

			// ä¿å­˜æ–‡æ¡£
			function saveDocument() {
				if (activeTitleIndex === -1 || documents.length === 0) return;

				if (isModified) {
					// æ›´æ–°å½“å‰æ´»åŠ¨å†…å®¹
					documents[activeTitleIndex].content = contentEditor.value;
					isModified = false;

					// æ„å»ºæ–‡æ¡£å†…å®¹
					let fullText = '';
					documents.forEach(doc => {
						fullText += `**${doc.title}**\n\n${doc.content}\n\n`;
					});

					// åˆ›å»ºä¸‹è½½é“¾æ¥
					const blob = new Blob([fullText], { type: 'text/plain' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'document.txt';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);

					updateStatus();
					alert('æ–‡æ¡£å·²ä¿å­˜');
				} else {
					alert('æ–‡æ¡£æ²¡æœ‰ä¿®æ”¹ï¼Œæ— éœ€ä¿å­˜');
				}
			}

			// å…³é—­å½“å‰æ–‡æ¡£
			function closeDocument() {
				if (isModified) {
					if (confirm('æ–‡æ¡£å·²ä¿®æ”¹ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿæ‰€æœ‰æœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
						newDocument();
						isModified = false;
					}
				} else {
					newDocument();
				}
			}

			// ç›‘å¬å†…å®¹ç¼–è¾‘äº‹ä»¶
			contentEditor.addEventListener('input', () => {
				isModified = true;
				updateStatus();

				// æ·»åŠ åˆ°å†å²è®°å½•
				addToHistory(contentEditor.value);
			});

			// æ·»åŠ åˆ°å†å²è®°å½•
			function addToHistory(content) {
				// æ·»åŠ æ–°çŠ¶æ€åˆ°å†å²è®°å½•
				window.editorHistory.add(content);

				// å¦‚æœå½“å‰ä¸æ˜¯æœ€æ–°çŠ¶æ€ï¼Œåˆ é™¤å½“å‰ä¹‹åçš„æ‰€æœ‰å†å²
				if (window.editorHistory.index < window.editorHistory.records.length - 1) {
					window.editorHistory.records = window.editorHistory.records.slice(0, window.editorHistory.index + 1);
				}
			}

			// æ’¤é”€æ“ä½œ
			function undo() {
				if (window.editorHistory.index > 0) {
					window.editorHistory.index--;
					contentEditor.value = window.editorHistory.records[window.editorHistory.index];
					isModified = true;
					updateStatus();
				}
			}

			// é‡åšæ“ä½œ
			function redo() {
				if (window.editorHistory.index < window.editorHistory.records.length - 1) {
					window.editorHistory.index++;
					contentEditor.value = window.editorHistory.records[window.editorHistory.index];
					isModified = true;
					updateStatus();
				}
			}

			// æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
			contentEditor.addEventListener('keydown', function (e) {
				// æ’¤é”€: Ctrl+Z
				if (e.ctrlKey && e.key === 'z') {
					e.preventDefault();
					undo();
				}

				// é‡åš: Ctrl+Y
				if (e.ctrlKey && e.key === 'y') {
					e.preventDefault();
					redo();
				}

				// Tabé”®æ”¯æŒ
				if (e.key === 'Tab') {
					e.preventDefault();
					const start = this.selectionStart;
					const end = this.selectionEnd;

					// åœ¨å…‰æ ‡ä½ç½®æ’å…¥Tab
					this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);

					// å°†å…‰æ ‡ç§»åˆ°æ’å…¥çš„Tabä¹‹å
					this.selectionStart = this.selectionEnd = start + 1;

					// æ ‡è®°ä¸ºå·²ä¿®æ”¹
					isModified = true;
					updateStatus();
				}
			});

			// æ·»åŠ å…¨å±€é”®ç›˜å¿«æ·é”®
			document.addEventListener('keydown', function (e) {
				// æœç´¢: Ctrl+F
				if (e.ctrlKey && e.key === 'f') {
					e.preventDefault();
					toggleSearchDialog();
				}

				// æŸ¥æ‰¾ä¸‹ä¸€ä¸ª: F3
				if (e.key === 'F3' && !e.shiftKey) {
					e.preventDefault();
					findNextMatch();
				}

				// æŸ¥æ‰¾ä¸Šä¸€ä¸ª: Shift+F3
				if (e.key === 'F3' && e.shiftKey) {
					e.preventDefault();
					findPreviousMatch();
				}
			});

			// å­—ä½“æ ·å¼æŒ‰é’®äº‹ä»¶å¤„ç†å‡½æ•°
			function changeFontSize() {
				const size = prompt('è¯·è¾“å…¥å­—å·å¤§å°ï¼ˆä¾‹å¦‚ï¼š14px, 1.2em, 120%ï¼‰:', '16px');
				if (size) {
					contentEditor.style.fontSize = size;
				}
			}

			function changeLineHeight() {
				const height = prompt('è¯·è¾“å…¥è¡Œé«˜ï¼ˆä¾‹å¦‚ï¼š1.5, 2.0ï¼‰:', '1.5');
				if (height) {
					contentEditor.style.lineHeight = height;
				}
			}

			function changeLetterSpacing() {
				const spacing = prompt('è¯·è¾“å…¥å­—é—´è·ï¼ˆä¾‹å¦‚ï¼š1px, 0.1emï¼‰:', '0px');
				if (spacing) {
					contentEditor.style.letterSpacing = spacing;
				}
			}

			// æ˜¾ç¤º/éšè—æœç´¢å¯¹è¯æ¡†
			// æœç´¢ç›¸å…³å˜é‡
			let searchDialogEventsInitialized = false;
			let searchResults = [];
			let currentResultIndex = -1;
			let highlightContainer = null;
			let highlightOverlays = [];

			// åˆ‡æ¢æœç´¢å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€
			function toggleSearchDialog() {
				const searchDialog = document.getElementById('search-dialog');
				if (!searchDialog) {
					console.error('search-dialog å…ƒç´ æœªæ‰¾åˆ°ï¼');
					return;
				}
				searchDialog.classList.toggle('active');

				if (searchDialog.classList.contains('active')) {
					// æ¸…é™¤ä¹‹å‰çš„æœç´¢å†…å®¹å’Œç»“æœ
					document.getElementById('search-input').value = '';
					document.getElementById('replace-input').value = '';
					document.getElementById('search-result-info').textContent = '';
					searchResults = [];
					currentResultIndex = -1;
					clearHighlights();

					// èšç„¦æœç´¢è¾“å…¥æ¡†
					document.getElementById('search-input').focus();

					// åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
					setupDialogDrag(searchDialog);

					// åªåœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
					if (!searchDialogEventsInitialized) {
						// æ·»åŠ æœç´¢å¯¹è¯æ¡†æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
						document.getElementById('find-btn').addEventListener('click', findText);
						document.getElementById('find-prev-btn').addEventListener('click', findPreviousMatch);
						document.getElementById('find-next-btn').addEventListener('click', findNextMatch);
						document.getElementById('replace-btn').addEventListener('click', replaceText);
						document.getElementById('replace-all-btn').addEventListener('click', replaceAllText);
						document.getElementById('close-search-btn').addEventListener('click', closeSearchDialog);

						// æ·»åŠ æœç´¢èŒƒå›´æŒ‰é’®äº‹ä»¶
						document.querySelectorAll('.scope-btn').forEach(btn => {
							btn.addEventListener('click', function () {
								document.querySelectorAll('.scope-btn').forEach(b => b.classList.remove('active'));
								this.classList.add('active');
							});
						});

						// æ·»åŠ æœç´¢è¾“å…¥æ¡†çš„å›è½¦é”®äº‹ä»¶
						document.getElementById('search-input').addEventListener('keydown', function (e) {
							if (e.key === 'Enter') {
								e.preventDefault();
								if (e.shiftKey) {
									findPreviousMatch();
								} else {
									findNextMatch();
								}
							}
						});

						// æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
						searchDialogEventsInitialized = true;
					}
				}
			}

			// æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
			function updateSearchResultInfo(message) {
				const resultInfo = document.getElementById('search-result-info');
				resultInfo.textContent = message;
			}

			// åˆ›å»ºé«˜äº®å®¹å™¨
			function createHighlightContainer() {
				if (highlightContainer) {
					clearHighlights();
				}

				highlightContainer = document.createElement('div');
				highlightContainer.className = 'highlight-container';
				highlightContainer.style.width = contentEditor.offsetWidth + 'px';
				highlightContainer.style.height = contentEditor.offsetHeight + 'px';
				highlightContainer.style.left = contentEditor.offsetLeft + 'px';
				highlightContainer.style.top = contentEditor.offsetTop + 'px';

				// æ’å…¥åˆ°ç¼–è¾‘å™¨ä¹‹å‰ï¼Œç¡®ä¿z-indexæ­£ç¡®
				contentEditor.parentNode.insertBefore(highlightContainer, contentEditor);
			}

			// æ¸…é™¤æ‰€æœ‰é«˜äº®
			function clearHighlights() {
				if (highlightContainer) {
					// ç§»é™¤æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
					contentEditor.removeEventListener('scroll', updateHighlightPositions);

					// ç§»é™¤é«˜äº®å®¹å™¨
					highlightContainer.remove();
					highlightContainer = null;
				}
				highlightOverlays = [];
			}

			// ç›‘å¬æ–‡æ¡£å†…å®¹å˜æ›´äº‹ä»¶
			contentEditor.addEventListener('input', function () {
				const searchDialog = document.getElementById('search-dialog');
				if (searchDialog && searchDialog.classList.contains('active')) {
					clearHighlights();
					findText();
				}
			});

			// æ›´æ–°é«˜äº®æ˜¾ç¤º
			function updateHighlights() {
				// æ¸…é™¤ç°æœ‰é«˜äº®
				clearHighlights();

				if (searchResults.length === 0 || currentResultIndex === -1) return;

				// æ£€æŸ¥ç¼–è¾‘å™¨æ˜¯å¦å·²åŠ è½½
				if (!contentEditor || !contentEditor.value) {
					console.error('ç¼–è¾‘å™¨å†…å®¹æœªåŠ è½½');
					updateSearchResultInfo('ç¼–è¾‘å™¨å†…å®¹æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');
					return;
				}

				// åˆ›å»ºæ–°çš„é«˜äº®å®¹å™¨
				createHighlightContainer();

				// æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
				contentEditor.addEventListener('scroll', updateHighlightPositions);

				// ç«‹å³æ›´æ–°é«˜äº®ä½ç½®
				updateHighlightPositions();

				// è®¡ç®—å½“å‰æ–‡æ¡£çš„å…¨å±€åç§»é‡
				let docOffset = 0;
				if (activeTitleIndex !== -1) {
					for (let i = 0; i < activeTitleIndex; i++) {
						docOffset += documents[i].content.length + 1; // +1 for newline
					}
				}

				// è®¡ç®—æ–‡æœ¬ä½ç½®
				const textContent = contentEditor.value;
				const textareaStyles = window.getComputedStyle(contentEditor);
				const lineHeight = parseInt(textareaStyles.lineHeight) || parseInt(textareaStyles.fontSize) * 1.2;
				const paddingLeft = parseInt(textareaStyles.paddingLeft) || 0;
				const paddingTop = parseInt(textareaStyles.paddingTop) || 0;
				const fontSize = parseInt(textareaStyles.fontSize);
				const charWidth = fontSize * 0.6; // ä¼°è®¡å­—ç¬¦å®½åº¦

				// è·å–ç¼–è¾‘å™¨çš„æ»šåŠ¨ä½ç½®
				const scrollTop = contentEditor.scrollTop;

				// ä¸ºæ¯ä¸ªæœç´¢ç»“æœåˆ›å»ºé«˜äº®
				for (let i = 0; i < searchResults.length; i++) {
					const result = searchResults[i];

					// è®¡ç®—å½“å‰æ–‡æ¡£ä¸­çš„ç›¸å¯¹ä½ç½®
					const relativeStart = result.start - docOffset;
					const relativeEnd = result.end - docOffset;

					// ç¡®ä¿åŒ¹é…é¡¹åœ¨å½“å‰æ–‡æ¡£èŒƒå›´å†…
					if (relativeStart >= 0 && relativeEnd <= textContent.length) {
						try {
							// ä½¿ç”¨æ›´å¯é çš„æ–¹å¼è·å–æ–‡æœ¬ä½ç½®
							const tempDiv = document.createElement('div');
							tempDiv.style.position = 'absolute';
							tempDiv.style.visibility = 'hidden';
							tempDiv.style.whiteSpace = 'pre-wrap';
							tempDiv.style.font = textareaStyles.font;
							tempDiv.style.width = contentEditor.offsetWidth + 'px';
							tempDiv.textContent = textContent.substring(0, relativeStart);
							document.body.appendChild(tempDiv);

							const top = tempDiv.offsetHeight;
							const left = tempDiv.offsetWidth;

							document.body.removeChild(tempDiv);

							// åˆ›å»ºé«˜äº®å…ƒç´ 
							const highlight = document.createElement('div');
							highlight.className = 'highlight-overlay';
							if (i === currentResultIndex) {
								highlight.classList.add('highlight-current');
							}

							highlight.style.left = left + 'px';
							highlight.style.top = (top - scrollTop) + 'px';
							highlight.style.width = (relativeEnd - relativeStart) * charWidth + 'px';
							highlight.style.height = lineHeight + 'px';

							highlightContainer.appendChild(highlight);
							highlightOverlays.push(highlight);
						} catch (error) {
							console.error('æœç´¢é«˜äº®é”™è¯¯:', error);
							updateSearchResultInfo('æœç´¢é«˜äº®å¤±è´¥: ' + error.message);
							continue;
						}
					}
				}

				// æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨æ»šåŠ¨æ—¶æ›´æ–°é«˜äº®ä½ç½®
				contentEditor.addEventListener('scroll', updateHighlightPositions);
			}

			// æ›´æ–°é«˜äº®ä½ç½®ï¼Œè€ƒè™‘æ»šåŠ¨
			function updateHighlightPositions() {
				if (!highlightContainer || highlightOverlays.length === 0) return;

				const scrollTop = contentEditor.scrollTop;
				const textareaStyles = window.getComputedStyle(contentEditor);
				const lineHeight = parseInt(textareaStyles.lineHeight) || parseInt(textareaStyles.fontSize) * 1.2;
				const paddingTop = parseInt(textareaStyles.paddingTop) || 0;

				// æ›´æ–°é«˜äº®å®¹å™¨ä½ç½®
				highlightContainer.style.top = contentEditor.offsetTop + 'px';

				// è®¡ç®—å½“å‰æ–‡æ¡£çš„å…¨å±€åç§»é‡
				let docOffset = 0;
				if (activeTitleIndex !== -1) {
					for (let i = 0; i < activeTitleIndex; i++) {
						docOffset += documents[i].content.length + 1; // +1 for newline
					}
				}

				// æ›´æ–°æ¯ä¸ªé«˜äº®å…ƒç´ çš„ä½ç½®
				for (let i = 0; i < Math.min(searchResults.length, highlightOverlays.length); i++) {
					const result = searchResults[i];
					const highlight = highlightOverlays[i];

					// è®¡ç®—å½“å‰æ–‡æ¡£ä¸­çš„ç›¸å¯¹ä½ç½®
					const relativeStart = result.start - docOffset;

					// ç¡®ä¿åŒ¹é…é¡¹åœ¨å½“å‰æ–‡æ¡£èŒƒå›´å†…
					if (relativeStart >= 0) {
						const beforeText = contentEditor.value.substring(0, relativeStart);
						const lines = beforeText.split('\n');
						const lineIndex = lines.length - 1;

						// æ›´æ–°å‚ç›´ä½ç½®ï¼Œè€ƒè™‘æ»šåŠ¨
						const top = lineIndex * lineHeight + paddingTop - scrollTop;
						highlight.style.top = top + 'px';
					}
				}
			}

			// æŸ¥æ‰¾æ–‡æœ¬
			function escapeRegExp(string) {
				return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
			}

			// æŸ¥æ‰¾æ–‡æœ¬
			function findText() {
				const searchDialog = document.getElementById('search-dialog');
				if (!searchDialog || !searchDialog.classList.contains('active')) {
					console.error('âŒ æœç´¢å¯¹è¯æ¡†æœªæ˜¾ç¤ºæˆ–æœªæ¿€æ´»ï¼');
					return;
				}

				const searchInput = document.getElementById('search-input');
				if (!searchInput) {
					console.error('âŒ search-input å…ƒç´ æœªæ‰¾åˆ°ï¼è¯·ç¡®ä¿æœç´¢å¯¹è¯æ¡†å·²æ˜¾ç¤ºã€‚');
					return;
				}

				const searchText = searchInput.value;
				if (!searchText || /^\s*$/.test(searchText)) {
					updateSearchResultInfo('è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬');
					return;
				}

				const searchScopeBtn = document.querySelector('.scope-btn.active');
				if (!searchScopeBtn) {
					updateSearchResultInfo('è¯·é€‰æ‹©æœç´¢èŒƒå›´ï¼ˆå½“å‰è§†å›¾/æ•´ä¸ªæ–‡æ¡£ï¼‰ã€‚');
					return;
				}
				const searchScope = searchScopeBtn.dataset.scope;

				const caseSensitive = document.getElementById('case-sensitive').checked;
				const wholeWord = document.getElementById('whole-word').checked;

				searchResults = [];
				currentResultIndex = -1;
				clearHighlights();

				let flags = caseSensitive ? 'g' : 'gi';
				let searchPattern = searchText;

				if (wholeWord) {
					searchPattern = `\\b${escapeRegExp(searchPattern)}\\b`;
				} else {
					searchPattern = escapeRegExp(searchPattern);
				}

				try {
					const regex = new RegExp(searchPattern, flags);

					if (searchScope === 'all') {
						// æœç´¢æ•´ä¸ªæ–‡æ¡£
						let docOffset = 0;
						documents.forEach((doc, docIndex) => {
							const docContent = doc.content;
							let match;
							while ((match = regex.exec(docContent)) !== null) {
								searchResults.push({
									start: docOffset + match.index,
									end: docOffset + match.index + match[0].length,
									text: match[0],
									docIndex: docIndex
								});
							}
							docOffset += docContent.length + 1; // +1 for newline
							regex.lastIndex = 0; // é‡ç½®æ­£åˆ™è¡¨è¾¾å¼
						});
					} else {
						// åªæœç´¢å½“å‰è§†å›¾
						const docContent = contentEditor.value;
						let match;
						while ((match = regex.exec(docContent)) !== null) {
							searchResults.push({
								start: match.index,
								end: match.index + match[0].length,
								text: match[0],
								docIndex: activeTitleIndex
							});
						}
					}

					if (searchResults.length > 0) {
						updateSearchResultInfo(`æ‰¾åˆ° ${searchResults.length} ä¸ªåŒ¹é…é¡¹`);
						currentResultIndex = 0;
						updateHighlights();
						findNextMatch();
					} else {
						updateSearchResultInfo('æœªæ‰¾åˆ°åŒ¹é…é¡¹');
					}
				} catch (error) {
					updateSearchResultInfo(`æœç´¢é”™è¯¯: ${error.message}`);
				}

				addToHistory(contentEditor.value);
			}

			// æŸ¥æ‰¾ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹

			function loadDocument(index) {
				if (index >= 0 && index < documents.length) {
					// ä¿å­˜å½“å‰æ–‡æ¡£å†…å®¹
					if (activeTitleIndex !== -1) {
						documents[activeTitleIndex].content = contentEditor.value;
					}

					// åˆ‡æ¢åˆ°æ–°æ–‡æ¡£
					activeTitleIndex = index;
					contentEditor.value = documents[index].content;

					// é‡ç½®æŸ¥æ‰¾çŠ¶æ€
					searchResults = [];
					currentResultIndex = -1;

					// æ›´æ–°æ ‡é¢˜åˆ—è¡¨é«˜äº®
					renderTitles();

					// æ›´æ–°æœç´¢ç»“æœé«˜äº®
					updateHighlights();

					// é‡ç½®å†å²è®°å½•
					window.editorHistory.records = [contentEditor.value];
					window.editorHistory.index = 0;

					// æ›´æ–°çŠ¶æ€æ 
					updateStatus();
				}
			}


			function closeSearch() {
				searchResults = [];
				currentResultIndex = -1;
				updateHighlights();
				const searchDialog = document.getElementById('search-dialog');
				if (searchDialog) {
					searchDialog.classList.remove('active');
				}
				clearHighlights();
			}

			function findNextMatch() {
				if (searchResults.length === 0) {
					findText();
					return;
				}

				const searchScopeBtn = document.querySelector('.scope-btn.active');
				const searchScope = searchScopeBtn ? searchScopeBtn.dataset.scope : 'current';

				if (currentResultIndex === -1) {
					currentResultIndex = 0;
				} else {
					currentResultIndex = (currentResultIndex + 1) % searchResults.length;
				}

				let result = searchResults[currentResultIndex];

				// åªåœ¨"æ•´ä¸ªæ–‡æ¡£"æœç´¢æ—¶æ£€æŸ¥æ–‡æ¡£åˆ‡æ¢
				if (searchScope === 'all' && activeTitleIndex !== -1 && documents.length > 1) {
					let docStart = 0;
					let docEnd = 0;

					for (let i = 0; i < documents.length; i++) {
						docEnd = docStart + documents[i].content.length;

						if (result.start >= docStart && result.start < docEnd) {
							if (i !== activeTitleIndex) {
								alert(`åŒ¹é…é¡¹ä½äºæ ‡é¢˜ "${documents[i].title}" ä¸­ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢æ–‡æ¡£ã€‚`);
								currentResultIndex = i;
								updateHighlights();
								return;
							} else {
								result.start -= docStart;
								result.end -= docStart;
							}
							break;
						}

						docStart = docEnd + 1;
					}
				}

				// å®šä½åˆ°åŒ¹é…é¡¹
				contentEditor.focus();
				contentEditor.setSelectionRange(result.start, result.end);

				// å¹³æ»‘æ»šåŠ¨
				const scrollPos = Math.max(0, result.start / contentEditor.value.length * contentEditor.scrollHeight - 100);
				contentEditor.scrollTo({
					top: scrollPos,
					behavior: 'smooth'
				});
				updateHighlights();

				// æ›´æ–°çŠ¶æ€ä¿¡æ¯
				const resultInfo = searchScope === 'current'
					? `åŒ¹é…é¡¹ ${currentResultIndex + 1} / ${searchResults.length}`
					: `åŒ¹é…é¡¹ ${currentResultIndex + 1} / ${searchResults.length} (æ–‡æ¡£: ${documents[activeTitleIndex].title})`;
				updateSearchResultInfo(resultInfo);
			}

			// æŸ¥æ‰¾ä¸Šä¸€ä¸ªåŒ¹é…é¡¹
			function findPreviousMatch() {
				if (searchResults.length === 0) {
					findText();
					return;
				}

				const searchScopeBtn = document.querySelector('.scope-btn.active');
				const searchScope = searchScopeBtn ? searchScopeBtn.dataset.scope : 'current';

				currentResultIndex = (currentResultIndex - 1 + searchResults.length) % searchResults.length;
				let result = searchResults[currentResultIndex];

				// åªåœ¨"æ•´ä¸ªæ–‡æ¡£"æœç´¢æ—¶æ£€æŸ¥æ–‡æ¡£åˆ‡æ¢
				if (searchScope === 'all' && activeTitleIndex !== -1 && documents.length > 1) {
					let docStart = 0;
					let docEnd = 0;

					for (let i = 0; i < documents.length; i++) {
						docEnd = docStart + documents[i].content.length;

						if (result.start >= docStart && result.start < docEnd) {
							if (i !== activeTitleIndex) {
								alert(`åŒ¹é…é¡¹ä½äºæ ‡é¢˜ "${documents[i].title}" ä¸­ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢æ–‡æ¡£ã€‚`);
								currentResultIndex = i;
								updateHighlights();
								return;
							} else {
								result.start -= docStart;
								result.end -= docStart;
							}
							break;
						}

						docStart = docEnd + 1;
					}
				}

				contentEditor.focus();
				contentEditor.setSelectionRange(result.start, result.end);
				// å¹³æ»‘æ»šåŠ¨å¹¶ç¡®ä¿é«˜äº®å¯è§
				const scrollPos = Math.max(0, result.start / contentEditor.value.length * contentEditor.scrollHeight - 100);
				contentEditor.scrollTo({
					top: scrollPos,
					behavior: 'smooth'
				});
				updateHighlights();

				// æ›´æ–°çŠ¶æ€ä¿¡æ¯
				const resultInfo = searchScope === 'current'
					? `åŒ¹é…é¡¹ ${currentResultIndex + 1} / ${searchResults.length}`
					: `åŒ¹é…é¡¹ ${currentResultIndex + 1} / ${searchResults.length} (æ–‡æ¡£: ${documents[activeTitleIndex].title})`;
				updateSearchResultInfo(resultInfo);
			}

			// æ›¿æ¢å½“å‰åŒ¹é…çš„æ–‡æœ¬
			function replaceText() {
				if (searchResults.length === 0 || currentResultIndex === -1) {
					updateSearchResultInfo('æ²¡æœ‰é€‰ä¸­çš„åŒ¹é…é¡¹å¯æ›¿æ¢');
					return;
				}

				const replaceInput = document.getElementById('replace-input').value;
				const result = searchResults[currentResultIndex];

				// æ›¿æ¢æ–‡æœ¬
				const content = contentEditor.value;
				contentEditor.value =
					content.substring(0, result.start) +
					replaceInput +
					content.substring(result.end);

				// æ ‡è®°ä¸ºå·²ä¿®æ”¹
				isModified = true;

				// æ›´æ–°æœç´¢ç»“æœ
				const lengthDiff = replaceInput.length - result.text.length;

				// æ›´æ–°åç»­æœç´¢ç»“æœçš„ä½ç½®
				for (let i = currentResultIndex + 1; i < searchResults.length; i++) {
					searchResults[i].start += lengthDiff;
					searchResults[i].end += lengthDiff;
				}

				// ç§»é™¤å½“å‰ç»“æœ
				searchResults.splice(currentResultIndex, 1);

				// æ›´æ–°å½“å‰ç´¢å¼•
				if (searchResults.length === 0) {
					currentResultIndex = -1;
					updateSearchResultInfo('æ›¿æ¢å®Œæˆï¼Œæœªæ‰¾åˆ°æ›´å¤šåŒ¹é…é¡¹');
				} else {
					currentResultIndex = Math.min(currentResultIndex, searchResults.length - 1);
					findNextMatch();
				}

				// æ›´æ–°çŠ¶æ€
				updateStatus();

				// æ·»åŠ åˆ°å†å²è®°å½•
				addToHistory(contentEditor.value);
			}

			// æ›¿æ¢æ‰€æœ‰åŒ¹é…çš„æ–‡æœ¬
			function replaceAllText() {
				const searchInput = document.getElementById('search-input').value;
				if (!searchInput) {
					updateSearchResultInfo('è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬');
					return;
				}

				const replaceInput = document.getElementById('replace-input').value;
				const content = contentEditor.value;
				const caseSensitive = document.getElementById('case-sensitive').checked;
				const wholeWord = document.getElementById('whole-word').checked;

				// åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼
				let flags = caseSensitive ? 'g' : 'gi';
				let searchPattern = searchInput;

				if (wholeWord) {
					searchPattern = `\\b${searchPattern}\\b`;
				}

				try {
					const regex = new RegExp(searchPattern, flags);

					// æ›¿æ¢æ‰€æœ‰åŒ¹é…é¡¹
					const newContent = content.replace(regex, replaceInput);
					const replacedCount = (content.match(regex) || []).length;

					// æ›´æ–°å†…å®¹
					contentEditor.value = newContent;

					// æ ‡è®°ä¸ºå·²ä¿®æ”¹
					isModified = true;

					// æ›´æ–°ç»“æœä¿¡æ¯
					updateSearchResultInfo(`å·²æ›¿æ¢ ${replacedCount} ä¸ªåŒ¹é…é¡¹`);

					// é‡ç½®æœç´¢ç»“æœ
					searchResults = [];
					currentResultIndex = -1;

					// æ›´æ–°çŠ¶æ€
					updateStatus();

					// æ·»åŠ åˆ°å†å²è®°å½•
					addToHistory(contentEditor.value);
				} catch (error) {
					updateSearchResultInfo(`æ›¿æ¢é”™è¯¯: ${error.message}`);
				}
			}

			// å…³é—­æœç´¢å¯¹è¯æ¡†
			function closeSearchDialog() {
				const searchDialog = document.getElementById('search-dialog');
				searchDialog.classList.remove('active');

				// é‡ç½®æœç´¢ç»“æœ
				searchResults = [];
				currentResultIndex = -1;

				// æ¸…é™¤é«˜äº®æ˜¾ç¤º
				clearHighlights();
			}

			// æ¸²æŸ“æ ‡é¢˜åˆ—è¡¨
			function renderTitles() {
				console.log('renderTitles called');
				titleList.innerHTML = '';
				documents.forEach((doc, index) => {
					const titleElement = document.createElement('div');
					titleElement.className = 'title-item';
					if (index === activeTitleIndex) {
						titleElement.classList.add('active');
					}

					// ç›´æ¥è®¾ç½®æ ‡é¢˜æ–‡æœ¬ï¼Œä¸åˆ›å»ºç¼–è¾‘æŒ‰é’®
					titleElement.textContent = doc.title;
					titleElement.addEventListener('click', () => {
						setActiveTitle(index);
					});

					titleList.appendChild(titleElement);
				});
			}

			// ç¼–è¾‘æ ‡é¢˜
			function editTitle(index) {
				const newTitle = prompt('ç¼–è¾‘æ ‡é¢˜:', documents[index].title);
				if (newTitle && newTitle.trim() !== '') {
					documents[index].title = newTitle.trim();
					renderTitles();
				}
			}

			// è®¾ç½®æ´»åŠ¨æ ‡é¢˜
			function setActiveTitle(index) {
				if (index < 0 || index >= documents.length) {
					console.error('æ— æ•ˆçš„æ ‡é¢˜ç´¢å¼•:', index);
					return;
				}

				if (activeTitleIndex !== -1) {
					// ä¿å­˜å½“å‰å†…å®¹
					documents[activeTitleIndex].content = contentEditor.value;
					isModified = true;
				}

				activeTitleIndex = index;
				renderTitles();
				contentEditor.value = documents[index].content;

				// é‡ç½®å†å²è®°å½•
				window.editorHistory.records = [contentEditor.value];
				window.editorHistory.index = 0;

				// è§¦å‘å†…å®¹æ›´æ–°äº‹ä»¶
				const event = new Event('input');
				contentEditor.dispatchEvent(event);

				updateStatus();
			}

			// æ·»åŠ æ–°æ ‡é¢˜
			function addTitle() {
				const newTitle = prompt('è¯·è¾“å…¥æ–°æ ‡é¢˜:', 'æ–°æ ‡é¢˜');
				if (newTitle) {
					documents.push({
						title: newTitle,
						content: ''
					});
					activeTitleIndex = documents.length - 1;
					renderTitles();
					contentEditor.value = '';
					updateStatus();
				}
			}

			// ç§»é™¤å½“å‰é€‰ä¸­çš„æ ‡é¢˜
			function removeTitle() {
				if (activeTitleIndex === -1 || documents.length <= 1) return;

				if (confirm(`ç¡®å®šè¦åˆ é™¤æ ‡é¢˜ "${documents[activeTitleIndex].title}" å—ï¼Ÿ`)) {
					documents.splice(activeTitleIndex, 1);
					activeTitleIndex = activeTitleIndex >= documents.length ? documents.length - 1 : activeTitleIndex;
					renderTitles();
					contentEditor.value = activeTitleIndex >= 0 ? documents[activeTitleIndex].content : '';
					updateStatus();
				}
			}

			// æ ‡é¢˜ä¸Šç§»
			function moveTitleUp() {
				if (activeTitleIndex <= 0) return;

				const temp = documents[activeTitleIndex - 1];
				documents[activeTitleIndex - 1] = documents[activeTitleIndex];
				documents[activeTitleIndex] = temp;
				activeTitleIndex--;
				renderTitles();
			}

			// æ ‡é¢˜ä¸‹ç§»
			function moveTitleDown() {
				if (activeTitleIndex >= documents.length - 1) return;

				const temp = documents[activeTitleIndex + 1];
				documents[activeTitleIndex + 1] = documents[activeTitleIndex];
				documents[activeTitleIndex] = temp;
				activeTitleIndex++;
				renderTitles();
			}

		});
	</script>
</body>

</html>