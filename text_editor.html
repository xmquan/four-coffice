<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>双栏文本编辑器</title>

	<!-- CSS样式部分 -->
	<style>
		/* 全局样式 */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: "Microsoft YaHei", Arial, sans-serif;
		}

		body {
			background-color: #e6e6e6;
			color: #333;
			height: 100vh;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			/* 隐藏浏览器滚动条 */
		}

		/* 主容器 */
		.container {
			width: 100%;
			margin: 20px auto;
			display: flex;
			flex-direction: column;
			height: calc(100vh - 40px);
			overflow: hidden;
			/* 隐藏浏览器滚动条 */
		}

		/* 顶部工具栏 */
		.top-toolbar {
			background-color: #d9d9d9;
			padding: 8px;
			display: flex;
			gap: 10px;
			border-top-left-radius: 5px;
			border-top-right-radius: 5px;
			flex-wrap: wrap;
			width: 100%;
		}

		/* 分隔线 */
		.separator {
			width: 1px;
			background-color: #aaa;
			margin: 0 5px;
		}

		/* 按钮通用样式 */
		.btn {
			padding: 6px 16px;
			min-width: 50px;
			height: 32px;
			background-color: #f0f0f0;
			border: 1px solid #ccc;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			letter-spacing: 2px;
			transition: all 0.2s;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			white-space: nowrap;
		}

		.btn:hover {
			background-color: #e0e0e0;
		}

		/* 主内容区域 */
		.main-content {
			display: flex;
			flex: 1;
			background-color: white;
			overflow: hidden;
			/* 隐藏浏览器滚动条 */
		}

		/* 左侧标题编辑区 */
		.title-editor {
			width: 318px;
			padding: 10px;
			border-right: 1px solid #ddd;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
		}

		/* 标题按钮区域 */
		.title-tools {
			display: flex;
			gap: 6px;
			margin-bottom: 10px;
			padding: 4px 0;
			flex-shrink: 0;
			/* 防止工具栏被压缩 */
		}

		/* 标题列表容器 */
		#title-list {
			flex: 1;
			overflow-y: auto;
			padding: 0 10px 10px 10px;
			/* 添加边框样式，与内容编辑区保持一致 */
			border: 1px solid #ddd;
			border-radius: 5px;
			/* 自定义滚动条样式 */
			scrollbar-width: thin;
			scrollbar-color: #999 #f0f0f0;
		}

		/* 自定义滚动条样式 - Webkit浏览器 */
		#title-list::-webkit-scrollbar {
			width: 8px;
		}

		#title-list::-webkit-scrollbar-track {
			background: #f0f0f0;
			border-radius: 4px;
		}

		#title-list::-webkit-scrollbar-thumb {
			background: #999;
			border-radius: 4px;
		}

		#title-list::-webkit-scrollbar-thumb:hover {
			background: #777;
		}

		/* 标题栏专用按钮样式 */
		.title-btn {
			padding: 4px 12px;
			min-width: 45px;
			height: 28px;
			background-color: #f5f5f5;
			border: 1px solid #ddd;
			border-radius: 4px;
			cursor: pointer;
			font-size: 13px;
			letter-spacing: 0px;
			transition: all 0.2s;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			white-space: nowrap;
		}

		.title-btn:hover {
			background-color: #eeeeee;
		}

		/* 右侧内容编辑区 */
		.content-panel {
			flex: 1;
			padding: 10px;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			/* 自定义滚动条样式 */
			scrollbar-width: thin;
			scrollbar-color: #999 #f0f0f0;
		}

		/* 自定义滚动条样式 - Webkit浏览器 */
		.content-panel::-webkit-scrollbar {
			width: 8px;
		}

		.content-panel::-webkit-scrollbar-track {
			background: #f0f0f0;
			border-radius: 4px;
		}

		.content-panel::-webkit-scrollbar-thumb {
			background: #999;
			border-radius: 4px;
		}

		.content-panel::-webkit-scrollbar-thumb:hover {
			background: #777;
		}

		/* 内容按钮区域 */
		.content-tools {
			display: flex;
			gap: 8px;
			margin-bottom: 10px;
			align-items: center;
		}

		/* 编辑区域样式 */
		.editor {
			flex: 1;
			outline: none;
			border: 1px solid #ddd;
			border-radius: 5px;
			padding: 10px;
			overflow-y: auto;
			resize: none;
			font-family: "Microsoft YaHei", Arial, sans-serif;
			font-size: 20px;
			letter-spacing: 2px;
			line-height: 1.5;
			/* 自定义滚动条样式 */
			scrollbar-width: thin;
			scrollbar-color: #999 #f0f0f0;
		}

		/* 自定义滚动条样式 - Webkit浏览器 */
		.editor::-webkit-scrollbar {
			width: 8px;
		}

		.editor::-webkit-scrollbar-track {
			background: #f0f0f0;
			border-radius: 4px;
		}

		.editor::-webkit-scrollbar-thumb {
			background: #999;
			border-radius: 4px;
		}

		.editor::-webkit-scrollbar-thumb:hover {
			background: #777;
		}

		/* 底部状态栏 */
		.status-bar {
			background-color: #d9d9d9;
			padding: 5px 10px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-size: 12px;
			border-bottom-left-radius: 5px;
			border-bottom-right-radius: 5px;
		}

		/* 状态消息样式 */
		.status-messages {
			display: flex;
			flex-direction: column;
			gap: 5px;
		}

		.status-message {
			background-color: #333;
			color: white;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 12px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
		}

		*/

		/* 弹窗遮罩层 */
		.modal-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			justify-content: center;
			align-items: center;
		}

		/* 弹窗容器 */
		.modal-container {
			background-color: white;
			border-radius: 5px;
			box-shadow: 0 3px 7px rgba(0, 0, 0, 0.3);
			width: 400px;
			max-width: 90%;
		}

		/* 弹窗标题 */
		.modal-header {
			padding: 12px 15px;
			background-color: #f7f7f7;
			border-bottom: 1px solid #ddd;
			border-top-left-radius: 4px;
			border-top-right-radius: 4px;
		}

		.modal-title {
			font-size: 16px;
			font-weight: bold;
		}

		/* 弹窗内容 */
		.modal-body {
			padding: 15px;
		}

		/* 弹窗底部 */
		.modal-footer {
			padding: 12px 15px;
			border-top: 1px solid #ddd;
			text-align: right;
		}

		/* 关闭按钮 */
		.close-btn {
			float: right;
			font-size: 21px;
			font-weight: bold;
			line-height: 1;
			color: #000;
			text-shadow: 0 1px 0 #fff;
			opacity: 0.2;
			cursor: pointer;
			background: transparent;
			border: 0;
		}

		.close-btn:hover {
			opacity: 0.5;
		}

		/* 搜索表单 */
		.search-form {
			display: flex;
			gap: 8px;
		}

		.search-input {
			flex: 1;
			padding: 8px;
			border: 1px solid #ccc;
			border-radius: 3px;
		}

		.search-btn {
			padding: 8px 15px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 3px;
			cursor: pointer;
		}

		.search-btn:hover {
			background-color: #45a049;
		}

		/* 下拉框样式 */
		.dropdown {
			padding: 6px 28px 6px 12px;
			border: 1px solid #ccc;
			border-radius: 3px;
			background: white url("data:image/svg+xml;utf8,<svg width='20' height='20' xmlns='http://www.w3.org/2000/svg'><polyline points='5,8 10,13 15,8' fill='none' stroke='%23bbb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>") no-repeat right 8px center/20px 20px;
			font-size: 14px;
			margin-right: 8px;
			min-width: 90px;
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			cursor: pointer;
		}

		/* 标题项样式 */
		.title-item {
			padding: 12px;
			margin-bottom: 8px;
			cursor: pointer;
			border-radius: 4px;
			background-color: white;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			transition: all 0.2s ease;
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-shrink: 0;
			/* 防止标题项被压缩 */
		}

		.title-item:hover {
			background-color: #f5f5f5;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
		}

		.title-item.active {
			background-color: #90caf9;
			box-shadow: 0 2px 6px rgba(144, 202, 249, 0.3);
			border-left: 4px solid #1976d2;
		}

		.title-item {
			font-weight: 500;
		}

		/* 搜索对话框样式 */
		.search-dialog {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 400px;
			max-height: 80vh;
			background-color: #e6e6e6;
			color: #333;
			border: 1px solid #ccc;
			border-radius: 5px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			padding: 20px;
			z-index: 1000;
			display: none;
			overflow-y: auto;
			/* 自定义滚动条样式 */
			scrollbar-width: thin;
			scrollbar-color: #999 #e6e6e6;
		}

		/* 自定义滚动条样式 - Webkit浏览器 */
		.search-dialog::-webkit-scrollbar {
			width: 8px;
		}

		.search-dialog::-webkit-scrollbar-track {
			background: #e6e6e6;
			border-radius: 4px;
		}

		.search-dialog::-webkit-scrollbar-thumb {
			background: #999;
			border-radius: 4px;
		}

		.search-dialog::-webkit-scrollbar-thumb:hover {
			background: #777;
		}

		.search-dialog.active {
			display: block;
		}

		.search-dialog .dialog-header {
			padding: 8px 16px;
			margin: -20px -20px 10px -20px;
			background: #d9d9d9;
			border-radius: 5px 5px 0 0;
			cursor: move;
			-webkit-user-select: none;
			user-select: none;
			font-weight: bold;
		}

		.search-dialog .close-button {
			position: absolute;
			right: 12px;
			top: 16px;
			font-size: 20px;
			color: #666;
			cursor: pointer;
			transform: scale(0.8) translateX(2px);
			transition: 0.2s ease;
		}

		.search-dialog .search-header {
			margin-top: 0;
			margin-bottom: 12px;
			font-size: 16px;
			font-weight: bold;
			color: #333;
			border-bottom: 1px solid #ccc;
			padding-bottom: 8px;
		}

		.search-dialog .search-content {
			padding: 8px 0;
		}

		.search-dialog .form-group {
			margin-bottom: 12px;
		}

		.search-dialog label {
			display: block;
			margin-bottom: 4px;
			font-size: 14px;
		}

		.search-dialog input[type="text"] {
			width: 96%;
			padding: 6px 12px;
			border: 1px solid #ccc;
			border-radius: 3px;
			font-size: 14px;
		}

		.search-dialog .options {
			display: flex;
			margin-bottom: 12px;
			flex-wrap: wrap;
		}

		.search-dialog .option {
			margin-right: 12px;
			font-size: 14px;
			display: flex;
			align-items: center;
		}

		.search-dialog .option input[type="checkbox"] {
			margin-right: 4px;
		}

		.search-dialog .buttons {
			display: flex;
			flex-wrap: wrap;
			gap: 5px;
			justify-content: space-between;
		}

		.search-dialog .buttons button,
		.search-dialog .scope-btn {
			padding: 4px 12px;
			font-size: 12px;
			border: 1px solid #ccc;
			border-radius: 3px;
			background-color: #f0f0f0;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.search-dialog .buttons button:hover,
		.search-dialog .scope-btn:hover {
			background-color: #e0e0e0;
		}

		.search-dialog .scope-btn.active {
			background-color: #90caf9;
			border-color: #90caf9;
			color: white;
		}

		.search-dialog .result-info {
			font-size: 12px;
			margin-top: 8px;
			color: #666;
		}

		input[type="file"] {
			display: none;
		}
	</style>
</head>

<body>
	<div class="container">
		<!-- 顶部工具栏 -->
		<div class="top-toolbar">
			<button id="new-btn" class="btn">新建</button>
			<button id="open-btn" class="btn">打开</button>
			<button id="save-btn" class="btn">保存</button>
			<button id="close-btn" class="btn">关闭</button>
			<div class="separator"></div>
			<button id="undo-btn" class="btn">撤销</button>
			<button id="redo-btn" class="btn">重做</button>
			<input type="file" id="file-input" accept=".txt" aria-label="打开文本文件">
		</div>

		<!-- 主内容区域 -->
		<div class="main-content">
			<!-- 左侧标题编辑区 -->
			<div class="title-editor">
				<!-- 标题按钮区域 -->
				<div class="title-tools">
					<button id="add-title-btn" class="title-btn">增加</button>
					<button id="remove-title-btn" class="title-btn">移除</button>
					<button id="edit-title-btn" class="title-btn">编辑</button>
					<button id="move-up-btn" class="title-btn">上移</button>
					<button id="move-down-btn" class="title-btn">下移</button>
				</div>
				<div id="title-list"></div>
			</div>

			<!-- 右侧内容编辑区 -->
			<div class="content-panel">
				<div class="content-tools">
					<select id="font-size-select" class="dropdown" aria-label="字号选择">
						<option value="20px">字号：20px</option>
						<option value="18px">字号：18px</option>
						<option value="20px">字号：20px</option>
						<option value="24px">字号：24px</option>
					</select>
					<select id="line-height-select" class="dropdown" aria-label="行距选择">
						<option value="1.5">行距：1.5</option>
						<option value="1.2">行距：1.2</option>
						<option value="1.5">行距：1.5</option>
						<option value="2.0">行距：2.0</option>
					</select>
					<select id="letter-spacing-select" class="dropdown" aria-label="字距选择">
						<option value="2px">字距：2px</option>
						<option value="1px">字距：1px</option>
						<option value="2px">字距：2px</option>
						<option value="4px">字距：4px</option>
					</select>
					<button id="search-btn" class="btn">搜索</button>
				</div>
				<textarea id="content-editor" class="editor" placeholder="请输入内容"></textarea>
				<!-- 底部状态栏 -->
				<div class="status-bar">
					<div id="status-messages" class="status-messages"></div>
					<div class="status-stats" id="status-info">行: 0 | 字数: 0 | 总字数: 0</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 搜索和替换对话框 -->
	<div id="search-dialog" class="search-dialog">
		<div class="dialog-header">搜索和替换</div>
		<div class="search-header">搜索选项</div>
		<div class="search-content">
			<div class="form-group">
				<label for="search-input">查找内容:</label>
				<input type="text" id="search-input" placeholder="输入要查找的文本">
			</div>
			<div class="form-group">
				<label for="replace-input">替换为:</label>
				<input type="text" id="replace-input" placeholder="输入要替换的文本">
			</div>
			<div class="options">
				<div class="option">
					<input type="checkbox" id="case-sensitive">
					<label for="case-sensitive">区分大小写</label>
				</div>
				<div class="option">
					<input type="checkbox" id="whole-word">
					<label for="whole-word">全字匹配</label>
				</div>
				<div class="option">
					<button id="search-current" class="scope-btn" data-scope="current">当前视图</button>
				</div>
				<div class="option">
					<button id="search-all" class="scope-btn active" data-scope="all">整个文档</button>
				</div>
			</div>
			<div class="buttons">
				<button id="find-btn">查找</button>
				<button id="find-prev-btn">上一个</button>
				<button id="find-next-btn">下一个</button>
				<button id="replace-btn">替换</button>
				<button id="replace-all-btn">全部替换</button>
				<button id="close-search-btn">关闭</button>
			</div>
			<div class="result-info" id="search-result-info"></div>
		</div>
	</div>

	<!-- JavaScript功能实现 -->
	<script>
		// 全局变量：存储所有文档对象
		window.documents = [];
		// 全局变量：当前激活的标题索引
		window.activeTitleIndex = -1;
		// 全局变量：标记文档是否被修改
		window.isModified = false;
		// 全局变量：搜索对话框事件是否已初始化
		window.searchDialogEventsInitialized = false;
		// 全局变量：编辑器历史记录系统
		window.editorHistory = {
			records: [""],
			index: 0,
			MAX: 100,

			// 添加历史记录方法
			add: function (content) {
				if (this.index < this.records.length - 1) {
					this.records = this.records.slice(0, this.index + 1);
				}
				this.records.push(content);
				this.index = this.records.length - 1;

				// 限制历史记录数量
				if (this.records.length > this.MAX) {
					this.records.shift();
					this.index--;
				}
			}
		};

		// 全局搜索相关变量
		let searchResults = [];
		let currentResultIndex = -1;

		// 全局updateStatus函数
		function updateStatus() {
			// 确保依赖变量已初始化
			if (typeof debouncedUpdateStatus !== 'undefined') {
				debouncedUpdateStatus();
			}
		}

		// 更新搜索结果信息
		function updateSearchResultInfo(message) {
			const resultInfo = document.getElementById('search-result-info');
			if (resultInfo) {
				resultInfo.textContent = message;
			}
		}

		// 查找文本
		function escapeRegExp(string) {
			return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
		}

		// 关闭搜索对话框
		function closeSearchDialog() {
			const searchDialog = document.getElementById('search-dialog');
			if (searchDialog) {
				searchDialog.classList.remove('active');

				// 重置搜索结果
				searchResults = [];
				currentResultIndex = -1;
			}
		}

		// 添加到历史记录
		function addToHistory(content) {
			// 添加新状态到历史记录
			window.editorHistory.add(content);

			// 如果当前不是最新状态，删除当前之后的所有历史
			if (window.editorHistory.index < window.editorHistory.records.length - 1) {
				window.editorHistory.records = window.editorHistory.records.slice(0, window.editorHistory.index + 1);
			}
		}

		// 设置活动标题
		function setActiveTitle(index) {
			if (index < 0 || index >= window.documents.length) {
				console.error('无效的标题索引:', index);
				return;
			}

			if (window.activeTitleIndex !== -1) {
				// 保存当前内容
				window.documents[window.activeTitleIndex].content = window.contentEditor.value;
				window.isModified = true;
			}

			window.activeTitleIndex = index;
			renderTitles();
			window.contentEditor.value = window.documents[index].content;

			// 重置历史记录
			window.editorHistory.records = [window.contentEditor.value];
			window.editorHistory.index = 0;

			// 触发内容更新事件
			const event = new Event('input');
			window.contentEditor.dispatchEvent(event);

			updateStatus();
		}

		// 渲染标题列表
		function renderTitles() {
			const titleList = document.getElementById('title-list');
			// console.log('renderTitles called');
			titleList.innerHTML = '';
			window.documents.forEach((doc, index) => {
				const titleElement = document.createElement('div');
				titleElement.className = 'title-item';
				if (index === window.activeTitleIndex) {
					titleElement.classList.add('active');
				}

				// 直接设置标题文本，不创建编辑按钮
				titleElement.textContent = doc.title;
				titleElement.addEventListener('click', () => {
					setActiveTitle(index);
				});

				titleList.appendChild(titleElement);
			});
		}

		// 当DOM完全加载后执行初始化
		document.addEventListener('DOMContentLoaded', function () {
			// 获取关键DOM元素引用			
			window.contentEditor = document.getElementById('content-editor');
			window.statusInfo = document.getElementById('status-info');
			const fileInput = document.getElementById('file-input');
			const titleList = document.getElementById('title-list');

			// 初始化编辑器，设置初始状态
			initEditor();

			// 顶部工具栏按钮事件绑定
			document.getElementById('new-btn').addEventListener('click', newDocument);
			document.getElementById('open-btn').addEventListener('click', () => fileInput.click());
			document.getElementById('save-btn').addEventListener('click', saveDocument);
			document.getElementById('close-btn').addEventListener('click', closeDocument);
			document.getElementById('undo-btn').addEventListener('click', undo);
			document.getElementById('redo-btn').addEventListener('click', redo);

			// 标题栏按钮事件绑定
			document.getElementById('add-title-btn').addEventListener('click', newDocument);
			document.getElementById('remove-title-btn').addEventListener('click', removeTitle);
			document.getElementById('move-up-btn').addEventListener('click', moveTitleUp);
			document.getElementById('move-down-btn').addEventListener('click', moveTitleDown);

			// 添加字体样式按钮事件
			document.getElementById('search-btn').addEventListener('click', toggleSearchDialog);

			// ================== 内容栏相关功能 ==================

			// 监听字号、行距、字距下拉框变化，实时应用到编辑区
			document.getElementById('font-size-select').addEventListener('change', function () {
				contentEditor.style.fontSize = this.value;
			});
			document.getElementById('line-height-select').addEventListener('change', function () {
				contentEditor.style.lineHeight = this.value;
			});
			document.getElementById('letter-spacing-select').addEventListener('change', function () {
				contentEditor.style.letterSpacing = this.value;
			});

			// 监听内容编辑事件，自动在新段落加TAB
			contentEditor.addEventListener('input', function (e) {
				// 判断是否是新起一行
				const value = contentEditor.value;
				const pos = contentEditor.selectionStart;
				// 如果刚输入回车，且当前位置在行首，则自动插入一个TAB
				if (pos > 1 && value[pos - 1] !== '\t' && value[pos - 2] === '\n') {
					contentEditor.value = value.slice(0, pos) + '\t' + value.slice(pos);
					contentEditor.selectionStart = contentEditor.selectionEnd = pos + 1;
				}
				isModified = true;
				updateStatus();

				// 添加到历史记录
				addToHistory(contentEditor.value);
			});

			// 工具栏编辑按钮 - 仅用于编辑标题
			document.getElementById('edit-title-btn').addEventListener('click', () => {
				if (activeTitleIndex === -1) {
					alert('请先选择要编辑的标题');
					return;
				}
				const newTitle = prompt('编辑标题:', documents[activeTitleIndex].title);
				if (newTitle && newTitle !== documents[activeTitleIndex].title) {
					documents[activeTitleIndex].title = newTitle;
					isModified = true;
					renderTitles();
					updateStatus();
				}
			});

			// 字体样式选择事件
			fileInput.addEventListener('change', function (event) {
				handleFileOpen(event);
				fileInput.value = ''; // 允许重复选择同一个文件
			});
			// 修改这一行，使用防抖版本的updateStatus
			contentEditor.addEventListener('input', debouncedUpdateStatus);

			// 初始化编辑器状态
			function initEditor() {
				// 确保DOM元素已加载
				if (!window.contentEditor || !window.statusInfo) {
					console.error('contentEditor 或 statusInfo 未正确初始化');
					return;
				}

				// 构建文档文本的函数
				function buildDocumentText() {
					let fullText = '';
					documents.forEach(doc => {
						fullText += `**${doc.title}**\n\n${doc.content}\n\n`;
					});
					return fullText;
				}

				// 设置自动保存定时器
				setInterval(() => {
					if (documents.length > 0 && activeTitleIndex !== -1) {
						documents[activeTitleIndex].content = window.contentEditor.value;
						localStorage.setItem('textEditorDocument', buildDocumentText());
					}
				}, 30000);

				// 初始化历史记录
				if (contentEditor) {
					window.editorHistory.records = [contentEditor.value];
				}
			}

			// 处理文件打开操作
			function handleFileOpen(event) {
				// console.log('文件选择事件触发');
				try {
					const file = event.target.files[0];
					if (!file) {
						// console.log('未选择文件');
						return;
					}

					// console.log('开始读取文件:', file.name);
					const reader = new FileReader();

					reader.onload = function (e) {
						// console.log('文件读取成功');
						try {
							const text = e.target.result;
							// console.log('解析文档内容');
							parseDocument(text);

							// console.log('更新界面');
							// 确保渲染前内容已更新
							if (documents.length > 0 && activeTitleIndex >= 0) {
								renderTitles();
								contentEditor.value = documents[activeTitleIndex].content;
								updateStatus();
								// console.log('界面更新完成');

								// 重置历史记录
								window.editorHistory.records = [contentEditor.value];
								window.editorHistory.index = 0;

								// 显示成功提示
								const statusMessages = document.getElementById('status-messages');
								statusMessages.textContent = `文件 "${file.name}" 加载成功`;
								setTimeout(() => {
									statusMessages.textContent = '';
								}, 3000);
							} else {
								console.error('文档解析失败，未生成有效内容');
								alert('文档解析失败，请检查文件格式');
							}
						} catch (parseError) {
							console.error('文档处理错误:', parseError);
							alert('文档处理错误: ' + parseError.message);
						}
					};

					reader.onerror = function (error) {
						console.error('文件读取失败:', error);
						alert('文件读取失败: ' + error.target.error.message);
					};

					reader.readAsText(file);
				} catch (error) {
					console.error('文件打开异常:', error);
					alert('文件打开异常: ' + error.message);
				}
			}

			// 保存文档
			function saveDocument() {
				if (activeTitleIndex === -1 || documents.length === 0) return;

				if (isModified) {
					// 更新当前活动内容
					documents[activeTitleIndex].content = contentEditor.value;
					isModified = false;

					// 构建文档内容
					let fullText = '';
					documents.forEach(doc => {
						fullText += `**${doc.title}**\n\n${doc.content}\n\n`;
					});

					// 创建下载链接
					const blob = new Blob([fullText], { type: 'text/plain' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = documents[activeTitleIndex].title + '.txt';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);

					updateStatus();

				} else {
					alert('文档没有修改，无需保存');
				}
			}

			// 撤销操作
			function undo() {
				if (window.editorHistory.index > 0) {
					window.editorHistory.index--;
					contentEditor.value = window.editorHistory.records[window.editorHistory.index];
					isModified = true;
					updateStatus();
				}
			}

			// 重做操作
			function redo() {
				if (window.editorHistory.index < window.editorHistory.records.length - 1) {
					window.editorHistory.index++;
					contentEditor.value = window.editorHistory.records[window.editorHistory.index];
					isModified = true;
					updateStatus();
				}
			}

			// 新建文档
			function newDocument() {
				const newTitle = prompt('请输入新标题:', '新标题');
				if (newTitle) {
					// 清空现有文档列表
					documents.length = 0;
					// 添加新文档
					documents.push({
						title: newTitle,
						content: ''
					});
					activeTitleIndex = 0;
					renderTitles();
					contentEditor.value = '';
					updateStatus();
					isModified = false; // 新文档未修改
				}
			}

			// 关闭当前文档
			function closeDocument() {
				if (documents.length > 0) {
					// 检查当前文档是否有修改
					if (isModified) {
						// 如果有修改，提示用户是否保存
						const userChoice = confirm('当前文档有修改，是否保存后再关闭？\n点击"确定"保存并关闭，点击"取消"直接关闭');
						if (userChoice) {
							saveDocument();
						}
					}

					// 执行关闭操作 - 清空整个文档
					documents.length = 0;
					activeTitleIndex = -1;
					renderTitles();
					contentEditor.value = '';
					updateStatus();
					isModified = false;
				} else {
					alert('没有可关闭的文档');
				}
			}

			// 添加键盘快捷键支持
			contentEditor.addEventListener('keydown', function (e) {
				// 撤销: Ctrl+Z
				if (e.ctrlKey && e.key === 'z') {
					e.preventDefault();
					undo();
				}

				// 重做: Ctrl+Y
				if (e.ctrlKey && e.key === 'y') {
					e.preventDefault();
					redo();
				}

				// Tab键支持
				if (e.key === 'Tab') {
					e.preventDefault();
					const start = this.selectionStart;
					const end = this.selectionEnd;

					// 在光标位置插入Tab
					this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);

					// 将光标移到插入的Tab之后
					this.selectionStart = this.selectionEnd = start + 1;

					// 标记为已修改
					isModified = true;
					updateStatus();
				}
			});

			// 添加全局键盘快捷键
			document.addEventListener('keydown', function (e) {
				// 搜索: Ctrl+F
				if (e.ctrlKey && e.key === 'f') {
					e.preventDefault();
					toggleSearchDialog();
				}

				// 查找下一个: F3
				if (e.key === 'F3' && !e.shiftKey) {
					e.preventDefault();
					findNextMatch();
				}

				// 查找上一个: Shift+F3
				if (e.key === 'F3' && e.shiftKey) {
					e.preventDefault();
					findPreviousMatch();
				}
			});

			// 移除当前选中的标题
			function removeTitle() {
				if (activeTitleIndex === -1 || documents.length <= 1) return;

				if (confirm(`确定要删除标题 "${documents[activeTitleIndex].title}" 吗？`)) {
					documents.splice(activeTitleIndex, 1);
					activeTitleIndex = activeTitleIndex >= documents.length ? documents.length - 1 : activeTitleIndex;
					renderTitles();
					contentEditor.value = activeTitleIndex >= 0 ? documents[activeTitleIndex].content : '';
					updateStatus();
				}
			}

			// 标题上移
			function moveTitleUp() {
				if (activeTitleIndex <= 0) return;

				const temp = documents[activeTitleIndex - 1];
				documents[activeTitleIndex - 1] = documents[activeTitleIndex];
				documents[activeTitleIndex] = temp;
				activeTitleIndex--;
				renderTitles();
			}

			// 标题下移
			function moveTitleDown() {
				if (activeTitleIndex >= documents.length - 1) return;

				const temp = documents[activeTitleIndex + 1];
				documents[activeTitleIndex + 1] = documents[activeTitleIndex];
				documents[activeTitleIndex] = temp;
				activeTitleIndex++;
				renderTitles();
			}

		});

		// ================== 搜索与替换功能 ==================

		// 显示或隐藏搜索弹窗
		function toggleSearchDialog() {
			const searchDialog = document.getElementById('search-dialog');
			if (!searchDialog) {
				console.error('search-dialog 元素未找到！');
				return;
			}
			searchDialog.classList.toggle('active');

			if (searchDialog.classList.contains('active')) {
				// 清除之前的搜索内容和结果
				document.getElementById('search-input').value = '';
				document.getElementById('replace-input').value = '';
				document.getElementById('search-result-info').textContent = '';
				searchResults = [];
				currentResultIndex = -1;

				// 聚焦搜索输入框
				document.getElementById('search-input').focus();

				// 初始化拖拽功能
				setupDialogDrag(searchDialog);

				// 只在第一次打开时添加事件监听器
				if (!searchDialogEventsInitialized) {
					// 添加搜索对话框按钮事件监听器
					document.getElementById('find-btn').addEventListener('click', findText);
					document.getElementById('find-prev-btn').addEventListener('click', findPreviousMatch);
					document.getElementById('find-next-btn').addEventListener('click', findNextMatch);
					document.getElementById('replace-btn').addEventListener('click', replaceText);
					document.getElementById('replace-all-btn').addEventListener('click', replaceAllText);
					// 添加关闭按钮事件
					document.getElementById('close-search-btn').addEventListener('click', closeSearchDialog);
					// 添加搜索范围按钮事件
					document.querySelectorAll('.scope-btn').forEach(btn => {
						btn.addEventListener('click', function () {
							document.querySelectorAll('.scope-btn').forEach(b => b.classList.remove('active'));
							this.classList.add('active');
						});
					});

					// 添加搜索输入框的回车键事件
					document.getElementById('search-input').addEventListener('keydown', function (e) {
						if (e.key === 'Enter') {
							e.preventDefault();
							if (e.shiftKey) {
								findPreviousMatch();
							} else {
								findNextMatch();
							}
						}
					});

					// 标记为已初始化
					searchDialogEventsInitialized = true;
				}
			}
		}

		// 查找文本并高亮或跳转
		function findText() {
			const searchDialog = document.getElementById('search-dialog');
			if (!searchDialog || !searchDialog.classList.contains('active')) {
				console.error('❌ 搜索对话框未显示或未激活！');
				return;
			}

			const searchInput = document.getElementById('search-input');
			if (!searchInput) {
				console.error('❌ search-input 元素未找到！请确保搜索对话框已显示。');
				return;
			}

			const searchText = searchInput.value;
			if (!searchText || /^\s*$/.test(searchText)) {
				updateSearchResultInfo('请输入要查找的文本');
				return;
			}

			const searchScopeBtn = document.querySelector('.scope-btn.active');
			if (!searchScopeBtn) {
				updateSearchResultInfo('请选择搜索范围（当前视图/整个文档）。');
				return;
			}
			const searchScope = searchScopeBtn.dataset.scope;

			const caseSensitive = document.getElementById('case-sensitive').checked;
			const wholeWord = document.getElementById('whole-word').checked;

			searchResults = [];
			currentResultIndex = -1;

			let flags = caseSensitive ? 'g' : 'gi';
			let searchPattern = searchText;

			if (wholeWord) {
				searchPattern = `\\b${searchPattern}\\b`;
			} else {
				searchPattern = escapeRegExp(searchPattern);
			}

			try {
				const regex = new RegExp(searchPattern, flags);

				if (searchScope === 'all') {
					// 搜索整个文档
					window.documents.forEach((doc, docIndex) => {
						const docContent = doc.content;
						let match;
						while ((match = regex.exec(docContent)) !== null) {
							searchResults.push({
								start: match.index,
								end: match.index + match[0].length,
								text: match[0],
								docIndex: docIndex
							});
						}
						regex.lastIndex = 0; // 重置正则表达式
					});
				} else {
					// 只搜索当前视图
					const docContent = window.contentEditor.value;
					let match;
					while ((match = regex.exec(docContent)) !== null) {
						searchResults.push({
							start: match.index,
							end: match.index + match[0].length,
							text: match[0],
							docIndex: window.activeTitleIndex
						});
					}
				}

				if (searchResults.length > 0) {
					updateSearchResultInfo(`找到 ${searchResults.length} 个匹配项`);
					currentResultIndex = 0;
					findNextMatch();
				} else {
					updateSearchResultInfo('未找到匹配项');
				}
			} catch (error) {
				updateSearchResultInfo(`搜索错误: ${error.message}`);
			}

			addToHistory(window.contentEditor.value);
		}

		// 查找下一个匹配项
		function findNextMatch() {
			if (searchResults.length === 0) {
				findText();
				return;
			}

			const searchScopeBtn = document.querySelector('.scope-btn.active');
			const searchScope = searchScopeBtn ? searchScopeBtn.dataset.scope : 'current';

			if (currentResultIndex === -1) {
				currentResultIndex = 0;
			} else {
				currentResultIndex = (currentResultIndex + 1) % searchResults.length;
			}

			let result = searchResults[currentResultIndex];

			// 只在"整个文档"搜索时检查文档切换
			if (searchScope === 'all' && window.activeTitleIndex !== -1 && window.documents.length > 1) {
				// 自动切换到匹配项所在标题
				if (result.docIndex !== window.activeTitleIndex) {
					setActiveTitle(result.docIndex);
					// 需要重新获取结果，因为在setActiveTitle后searchResults可能已改变
					result = searchResults[currentResultIndex];
				}
			}

			// 定位到匹配项
			window.contentEditor.focus();
			window.contentEditor.setSelectionRange(result.start, result.end);

			// 平滑滚动
			const scrollPos = Math.max(0, result.start / window.contentEditor.value.length * window.contentEditor.scrollHeight - 100);
			window.contentEditor.scrollTo({
				top: scrollPos,
				behavior: 'smooth'
			});

			// 更新状态信息
			const resultInfo = searchScope === 'current'
				? `匹配项 ${currentResultIndex + 1} / ${searchResults.length}`
				: `匹配项 ${currentResultIndex + 1} / ${searchResults.length} (文档: ${window.documents[window.activeTitleIndex].title})`;

			updateSearchResultInfo(resultInfo);
		}

		// 查找上一个匹配项
		function findPreviousMatch() {
			if (searchResults.length === 0) {
				findText();
				return;
			}

			const searchScopeBtn = document.querySelector('.scope-btn.active');
			const searchScope = searchScopeBtn ? searchScopeBtn.dataset.scope : 'current';

			currentResultIndex = (currentResultIndex - 1 + searchResults.length) % searchResults.length;
			let result = searchResults[currentResultIndex];

			// 只在"整个文档"搜索时检查文档切换
			if (searchScope === 'all' && window.activeTitleIndex !== -1 && window.documents.length > 1) {
				// 自动切换到匹配项所在标题
				if (result.docIndex !== window.activeTitleIndex) {
					setActiveTitle(result.docIndex);
					// 需要重新获取结果，因为在setActiveTitle后searchResults可能已改变
					result = searchResults[currentResultIndex];
				}
			}

			window.contentEditor.focus();
			window.contentEditor.setSelectionRange(result.start, result.end);
			// 平滑滚动并确保高亮可见
			const scrollPos = Math.max(0, result.start / window.contentEditor.value.length * window.contentEditor.scrollHeight - 100);
			window.contentEditor.scrollTo({
				top: scrollPos,
				behavior: 'smooth'
			});

			// 更新状态信息
			const resultInfo = searchScope === 'current'
				? `匹配项 ${currentResultIndex + 1} / ${searchResults.length}`
				: `匹配项 ${currentResultIndex + 1} / ${searchResults.length} (文档: ${window.documents[window.activeTitleIndex].title})`;
			updateSearchResultInfo(resultInfo);
		}

		// 替换当前匹配项
		function replaceText() {
			if (searchResults.length === 0 || currentResultIndex === -1) {
				updateSearchResultInfo('没有选中的匹配项可替换');
				return;
			}

			const replaceInput = document.getElementById('replace-input').value;
			const result = searchResults[currentResultIndex];

			// 替换文本
			const content = window.contentEditor.value;
			window.contentEditor.value =
				content.substring(0, result.start) +
				replaceInput +
				content.substring(result.end);

			// 标记为已修改
			window.isModified = true;

			// 更新搜索结果
			const lengthDiff = replaceInput.length - result.text.length;

			// 更新后续搜索结果的位置
			for (let i = currentResultIndex + 1; i < searchResults.length; i++) {
				searchResults[i].start += lengthDiff;
				searchResults[i].end += lengthDiff;
			}

			// 移除当前结果
			searchResults.splice(currentResultIndex, 1);

			// 更新当前索引
			if (searchResults.length === 0) {
				currentResultIndex = -1;
				updateSearchResultInfo('替换完成，未找到更多匹配项');
			} else {
				currentResultIndex = Math.min(currentResultIndex, searchResults.length - 1);
				findNextMatch();
			}

			// 更新状态
			updateStatus();

			// 添加到历史记录
			addToHistory(window.contentEditor.value);
		}

		// 替换所有匹配项
		function replaceAllText() {
			const searchInput = document.getElementById('search-input').value;
			if (!searchInput) {
				updateSearchResultInfo('请输入要查找的文本');
				return;
			}

			const replaceInput = document.getElementById('replace-input').value;
			const content = window.contentEditor.value;
			const caseSensitive = document.getElementById('case-sensitive').checked;
			const wholeWord = document.getElementById('whole-word').checked;

			// 创建正则表达式
			let flags = caseSensitive ? 'g' : 'gi';
			let searchPattern = searchInput;

			if (wholeWord) {
				searchPattern = `\\b${searchPattern}\\b`;
			} else {
				// 修改:使用全局escapeRegExp函数
				searchPattern = escapeRegExp(searchInput);
			}

			try {
				const regex = new RegExp(searchPattern, flags);

				// 替换所有匹配项
				const newContent = content.replace(regex, replaceInput);
				const replacedCount = (content.match(regex) || []).length;

				// 更新内容
				window.contentEditor.value = newContent;

				// 标记为已修改
				window.isModified = true;

				// 更新结果信息
				updateSearchResultInfo(`已替换 ${replacedCount} 个匹配项`);

				// 重置搜索结果
				searchResults = [];
				currentResultIndex = -1;

				// 更新状态
				updateStatus();

				// 添加到历史记录
				addToHistory(window.contentEditor.value);
			} catch (error) {
				updateSearchResultInfo(`替换错误: ${error.message}`);
			}
		}

		// ================== 状态栏与消息 ==================

		// 防抖后更新状态栏统计信息
		const debouncedUpdateStatus = debounce(function () {
			// 安全访问依赖变量
			if (typeof window.activeTitleIndex === 'undefined' || window.activeTitleIndex === -1) return;
			if (!window.contentEditor || !window.statusInfo || !window.documents) return;

			const text = window.contentEditor.value;
			const lines = text.split('\n').length;
			// 当前页非空白字符数
			const currentCount = text.replace(/\s/g, '').length;

			// 计算总字数（所有文档内容去除空白后的总长度）
			let totalCount = 0;
			window.documents.forEach(doc => {
				const docText = doc.content.replace(/\s/g, '');
				totalCount += docText.length;
			});

			window.statusInfo.textContent = `行: ${lines} | 当前字数: ${currentCount} | 总字数: ${totalCount}`;
		}, 300);

		// 添加临时状态消息
		function addStatusMessage(message) {
			// 消息显示时间（毫秒）
			const MESSAGE_TIMEOUT = 5000;
			const statusMessages = document.getElementById('status-messages');
			if (!statusMessages) {
				console.warn('状态消息容器未找到，请确保存在 id="status-messages" 的元素');
				return;
			}

			const messageElement = document.createElement('span');
			messageElement.className = 'status-message';
			messageElement.textContent = message;
			statusMessages.appendChild(messageElement);

			// 自动移除消息
			const timeoutId = setTimeout(() => {
				messageElement.remove();
			}, MESSAGE_TIMEOUT);

			// 清理定时器
			messageElement.dataset.timeoutId = timeoutId;
		}

		// ================== 其它辅助函数 ==================

		// 防抖函数，避免高频操作
		function debounce(func, wait) {
			let timeout;
			return function () {
				clearTimeout(timeout);
				timeout = setTimeout(func, wait);
			};
		}

		// 弹窗拖拽功能
		function setupDialogDrag(dialog) {
			const header = dialog.querySelector('.dialog-header');
			if (!header) return;

			let isDragging = false;
			let offsetX, offsetY;

			header.addEventListener('mousedown', (e) => {
				isDragging = true;
				offsetX = e.clientX - dialog.getBoundingClientRect().left;
				offsetY = e.clientY - dialog.getBoundingClientRect().top;
				dialog.style.cursor = 'grabbing';
				e.preventDefault();
			});

			document.addEventListener('mousemove', (e) => {
				if (!isDragging) return;

				let left = e.clientX - offsetX;
				let top = e.clientY - offsetY;

				// 限制不超出视口
				const maxLeft = window.innerWidth - dialog.offsetWidth;
				const maxTop = window.innerHeight - dialog.offsetHeight;

				left = Math.max(0, Math.min(left, maxLeft));
				top = Math.max(0, Math.min(top, maxTop));

				dialog.style.left = left + 'px';
				dialog.style.top = top + 'px';
				dialog.style.transform = 'none';
			});

			document.addEventListener('mouseup', () => {
				isDragging = false;
				dialog.style.cursor = '';
			});
		}

		// 解析文档内容为标题和正文
		function parseDocument(text) {
			window.documents = [];
			let currentPos = 0;

			// 使用matchAll一次性找到所有标题
			const titleMatches = [...text.matchAll(/(\*\*(.+?)\*\*|\*\*\s(.+?)\s\*\*|\[(.+?)\]|【(.+?)】)/g)];

			if (titleMatches.length === 0) {
				// 如果没有标题，整个文档作为一个未命名标题
				window.documents.push({
					title: "未命名标题",
					content: addTabToParagraphs(text.trim())
				});
				window.activeTitleIndex = 0;
				return;
			}

			// 处理第一个标题之前的内容
			if (titleMatches[0].index > 0) {
				const initialContent = text.substring(0, titleMatches[0].index).trim();
				if (initialContent) {
					window.documents.push({
						title: "未命名标题",
						content: addTabToParagraphs(initialContent)
					});
				}
			}

			// 处理每个标题及其内容
			for (let i = 0; i < titleMatches.length; i++) {
				const match = titleMatches[i];
				const title = match[2] || match[3] || match[4];

				// 计算当前标题内容的结束位置
				let contentEnd = text.length;
				if (i < titleMatches.length - 1) {
					// 如果不是最后一个标题，内容结束于下一个标题的开始
					contentEnd = titleMatches[i + 1].index;
				}

				// 提取当前标题的内容
				const content = text.substring(match.index + match[0].length, contentEnd).trim();

				// 添加到文档列表
				window.documents.push({
					title: title.trim(),
					content: addTabToParagraphs(content)
				});
			}

			window.activeTitleIndex = 0;
		}

		// 新增：为每个段落开头加TAB
		function addTabToParagraphs(text) {
			// 以换行分段，非空行前加\t
			return text.split('\n').map(line => line.trim() ? '\t' + line.trim() : '').join('\n');
		}
	</script>
</body>

</html>